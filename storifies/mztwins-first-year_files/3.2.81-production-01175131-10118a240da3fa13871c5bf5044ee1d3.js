function Hammer(e,t,n){function r(e){return e.touches?e.touches.length:1}function i(e){if(e=e||window.event,L){for(var t,n=[],r=0,i=e.touches.length;i>r;r++)t=e.touches[r],n.push({x:t.pageX,y:t.pageY});return n}var s=document,o=s.body;return[{x:e.pageX||e.clientX+(s&&s.scrollLeft||o&&o.scrollLeft||0)-(s&&s.clientLeft||o&&s.clientLeft||0),y:e.pageY||e.clientY+(s&&s.scrollTop||o&&o.scrollTop||0)-(s&&s.clientTop||o&&s.clientTop||0)}]}function s(e,t){return 180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI}function o(e,t){if(2==e.length&&2==t.length){var n,r;n=e[0].x-e[1].x,r=e[0].y-e[1].y;var i=Math.sqrt(n*n+r*r);n=t[0].x-t[1].x,r=t[0].y-t[1].y;var s=Math.sqrt(n*n+r*r);return s/i}return 0}function a(e,t){if(2==e.length&&2==t.length){var n,r;n=e[0].x-e[1].x,r=e[0].y-e[1].y;var i=180*Math.atan2(r,n)/Math.PI;n=t[0].x-t[1].x,r=t[0].y-t[1].y;var s=180*Math.atan2(r,n)/Math.PI;return s-i}return 0}function l(e,t){t.touches=i(t.originalEvent),t.type=e,p(g["on"+e])&&g["on"+e].call(g,t)}function u(e){e=e||window.event,e.preventDefault?(e.preventDefault(),e.stopPropagation()):(e.returnValue=!1,e.cancelBubble=!0)}function c(){C={},T=!1,S=0,x=0,_=0,N=null}function d(n){switch(n.type){case"mousedown":case"touchstart":C.start=i(n),$=(new Date).getTime(),S=r(n),T=!0,y=n;var s=e.getBoundingClientRect(),d=e.clientTop||document.body.clientTop||0,h=e.clientLeft||document.body.clientLeft||0,f=window.pageYOffset||e.scrollTop||document.body.scrollTop,p=window.pageXOffset||e.scrollLeft||document.body.scrollLeft;M={top:s.top+f-d,left:s.left+p-h},O=!0,F.hold(n),t.prevent_default&&u(n);break;case"mousemove":case"touchmove":if(!O)return!1;b=n,C.move=i(n),F.transform(n)||F.drag(n);break;case"mouseup":case"mouseout":case"touchcancel":case"touchend":if(!O||"transform"!=N&&n.touches&&n.touches.length>0)return!1;O=!1,w=n,F.swipe(n),"drag"==N?l("dragend",{originalEvent:n,direction:k,distance:x,angle:_}):"transform"==N?l("transformend",{originalEvent:n,position:C.center,scale:o(C.start,C.move),rotation:a(C.start,C.move)}):F.tap(y),E=N,l("release",{originalEvent:n,gesture:N}),c()}}function h(e,t){if(!t&&window.event&&window.event.toElement&&(t=window.event.toElement),e===t)return!0;if(t)for(var n=t.parentNode;null!==n;){if(n===e)return!0;n=n.parentNode}return!1}function f(e,t){var n={};if(!t)return e;for(var r in e)n[r]=r in t?t[r]:e[r];return n}function p(e){return"[object Function]"==Object.prototype.toString.call(e)}function m(e,t,n){t=t.split(" ");for(var r=0,i=t.length;i>r;r++)e.addEventListener?e.addEventListener(t[r],n,!1):document.attachEvent&&e.attachEvent("on"+t[r],n)}var g=this,v={prevent_default:!1,css_hacks:!0,swipe:!0,swipe_time:200,swipe_min_distance:20,drag:!0,drag_vertical:!0,drag_horizontal:!0,drag_min_distance:20,transform:!0,scale_treshold:.1,rotation_treshold:15,tap:!0,tap_double:!0,tap_max_interval:300,tap_max_distance:10,tap_double_distance:20,hold:!0,hold_timeout:500};t=f(v,t),function(){if(!t.css_hacks)return!1;for(var n=["webkit","moz","ms","o",""],r={userSelect:"none",touchCallout:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"},i="",s=0;s<n.length;s++)for(var o in r)i=o,n[s]&&(i=n[s]+i.substring(0,1).toUpperCase()+i.substring(1)),e.style[i]=r[o]}();var y,b,w,x=0,_=0,k=0,C={},S=0,T=!1,N=null,E=null,$=null,A={x:0,y:0},D=null,j=null,M={},O=!1,L="ontouchstart"in window;this.option=function(e,r){return r!=n&&(t[e]=r),t[e]},this.getDirectionFromAngle=function(e){var t,n,r={down:e>=45&&135>e,left:e>=135||-135>=e,up:-45>e&&e>-135,right:e>=-45&&45>=e};for(n in r)if(r[n]){t=n;break}return t};var F={hold:function(e){t.hold&&(N="hold",clearTimeout(j),j=setTimeout(function(){"hold"==N&&l("hold",{originalEvent:e,position:C.start})},t.hold_timeout))},swipe:function(e){if(C.move){var n=C.move[0].x-C.start[0].x,r=C.move[0].y-C.start[0].y;x=Math.sqrt(n*n+r*r);var i=(new Date).getTime(),o=i-$;if(t.swipe&&t.swipe_time>o&&x>t.swipe_min_distance){_=s(C.start[0],C.move[0]),k=g.getDirectionFromAngle(_),N="swipe";var a={x:C.move[0].x-M.left,y:C.move[0].y-M.top},u={originalEvent:e,position:a,direction:k,distance:x,distanceX:n,distanceY:r,angle:_};l("swipe",u)}}},drag:function(e){var n=C.move[0].x-C.start[0].x,r=C.move[0].y-C.start[0].y;if(x=Math.sqrt(n*n+r*r),t.drag&&x>t.drag_min_distance||"drag"==N){_=s(C.start[0],C.move[0]),k=g.getDirectionFromAngle(_);var i="up"==k||"down"==k;if((i&&!t.drag_vertical||!i&&!t.drag_horizontal)&&x>t.drag_min_distance)return;N="drag";var o={x:C.move[0].x-M.left,y:C.move[0].y-M.top},a={originalEvent:e,position:o,direction:k,distance:x,distanceX:n,distanceY:r,angle:_};T&&(l("dragstart",a),T=!1),l("drag",a),u(e)}},transform:function(e){if(t.transform){if(2!=r(e))return!1;var n=a(C.start,C.move),i=o(C.start,C.move);if("drag"!=N&&("transform"==N||Math.abs(1-i)>t.scale_treshold||Math.abs(n)>t.rotation_treshold)){N="transform",C.center={x:(C.move[0].x+C.move[1].x)/2-M.left,y:(C.move[0].y+C.move[1].y)/2-M.top};var s={originalEvent:e,position:C.center,scale:i,rotation:n};return T&&(l("transformstart",s),T=!1),l("transform",s),u(e),!0}}return!1},tap:function(e){var n=(new Date).getTime(),r=n-$;if(!t.hold||t.hold&&t.hold_timeout>r){var i=function(){if(A&&t.tap_double&&"tap"==E&&$-D<t.tap_max_interval){var e=Math.abs(A[0].x-C.start[0].x),n=Math.abs(A[0].y-C.start[0].y);return A&&C.start&&Math.max(e,n)<t.tap_double_distance}return!1}();if(i)N="double_tap",D=null,l("doubletap",{originalEvent:e,position:C.start}),u(e);else{var s=C.move?Math.abs(C.move[0].x-C.start[0].x):0,o=C.move?Math.abs(C.move[0].y-C.start[0].y):0;x=Math.max(s,o),x<t.tap_max_distance&&(N="tap",D=n,A=C.start,t.tap&&(l("tap",{originalEvent:e,position:C.start}),u(e)))}}}};L?m(e,"touchstart touchmove touchend touchcancel",d):(m(e,"mouseup mousedown mousemove",d),m(e,"mouseout",function(t){h(e,t.relatedTarget)||d(t)}))}!function(e){e.oauthpopup=function(t){if(!t||!t.path)throw new Error("options.path must not be empty");t=e.extend({windowName:"ConnectWithOAuth",windowOptions:"location=0,status=0,width=800,height=400",callback:function(){window.location.reload()}},t);var n=window.open(t.path,t.windowName,t.windowOptions),r=window.setInterval(function(){return n?(n.closed&&(window.clearInterval(r),t.callback()),void 0):(window.clearInterval(r),console&&console.error("Please make sure your browser is allowing popups for this domain"),t.callback(!1))},1e3)}}(jQuery),jQuery.fn.hammer=function(e){return this.each(function(){var t=new Hammer(this,e),n=jQuery(this);n.data("hammer",t);for(var r=["hold","tap","doubletap","transformstart","transform","transformend","dragstart","drag","dragend","swipe","release"],i=0;i<r.length;i++)t["on"+r[i]]=function(e,t){return function(n){e.trigger(jQuery.Event(t,n))}}(n,r[i])})},function(e,t,n){function r(e){return e=e||location.href,"#"+e.replace(/^[^#]*#?(.*)$/,"$1")}var i,s="hashchange",o=document,a=e.event.special,l=o.documentMode,u="on"+s in t&&(l===n||l>7);e.fn[s]=function(e){return e?this.bind(s,e):this.trigger(s)},e.fn[s].delay=50,a[s]=e.extend(a[s],{setup:function(){return u?!1:(e(i.start),void 0)},teardown:function(){return u?!1:(e(i.stop),void 0)}}),i=function(){function i(){var n=r(),o=f(c);n!==c?(h(c=n,o),e(t).trigger(s)):o!==c&&(location.href=location.href.replace(/#.*/,"")+o),a=setTimeout(i,e.fn[s].delay)}var a,l={},c=r(),d=function(e){return e},h=d,f=d;return l.start=function(){a||i()},l.stop=function(){a&&clearTimeout(a),a=n},e.browser.msie&&!u&&function(){var t,n;l.start=function(){t||(n=e.fn[s].src,n=n&&n+r(),t=e('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){n||h(r()),i()}).attr("src",n||"javascript:0").insertAfter("body")[0].contentWindow,o.onpropertychange=function(){try{"title"===event.propertyName&&(t.document.title=o.title)}catch(e){}})},l.stop=d,f=function(){return r(t.location.href)},h=function(n,r){var i=t.document,a=e.fn[s].domain;n!==r&&(i.title=o.title,i.open(),a&&i.write('<script>document.domain="'+a+'"</script>'),i.close(),t.location.hash=n)}}(),l}()}(jQuery,this),s.Button=s.Class.extend({initialize:function(e,t){return this.options={toggle:!1,activeClass:"active"},this.setOptions(t),this.button=$(e),this.options.title&&this.button.attr("title",this.options.title),this.button.bind("mousedown.button",_.bind(this.mousedown,this)),this.button.bind("click.button",_.bind(this.click,this)),this},mousedown:function(e){return this.options.mousedown&&this.options.mousedown(e),this},click:function(e){return e.preventDefault(),this.disabled?!1:(this.options.click&&this.options.click(e),this.options.toggle&&this.toggle(e),this)},activate:function(e){return this.options.activate&&!this.options.activate(e)?!1:(this.button.addClass(this.options.activeClass),this)},deactivate:function(e){return this.options.deactivate&&!this.options.deactivate(e)?!1:(this.button.removeClass(this.options.activeClass),this)},enable:function(){return this.disabled=!1,this.button.removeAttr("disabled"),this},disable:function(){return this.disabled=!0,this.button.attr("disabled","disabled"),this},hide:function(){return this.button.hide(),this},show:function(){return this.button.show(),this},toggle:function(e){return this.active()?this.deactivate(e):this.activate(e),this},active:function(){return this.button.hasClass(this.options.activeClass)}}),s.Dropdown=s.Button.extend({initialize:function(e,t,n){n=n||{},n.toggle=!0,this.supr(e,n),this.menu=$(t),this._menu=t},setPosition:function(){var e=this.options.gap?this.options.gap:0;return this.menu.css({top:this.button.position().top+this.button.outerHeight()+e,minWidth:this.button.innerWidth()+"px"}),this.options.right&&this.menu.css({right:this.options.right}),this},activate:function(e){var t=this;return e&&e.stopPropagation(),this.supr(e)?(this.menu.addClass(this.options.activeClass).show(),$(this.button).trigger("click.dropdown"),_.defer(function(){$(window).bind("click.dropdown keyup.dropdown",_.bind(t.deactivate,t))}),this):!1},deactivate:function(e){if(e){if(this.options.exceptionId&&$(e.target).attr("id")===this.options.exceptionId)return;if(!(e.currentTarget==this.button[0]||e.keyCode&&27==e.keyCode||0==this.menu.find(e.target).length||this.options.isList&&this.menu.find($(e.target).parent()).length>0))return;$(window).unbind(e)}else $(window).unbind();return this.supr(e)?(this.menu.removeClass(this.options.activeClass).hide(),this):!1},hide:function(){return this.menu.hide(),this.button.hide(),this},show:function(){return this.button.show(),this.setPosition(),this}}),s.Modal=s.Class.extend({overlayId:"#page-overlay",initialize:function(e,t){this.options={closeable:!0},this.setOptions(t),this.modal=$(e),this.overlay=$(this.overlayId),this.overlay.length||(this.overlay=$("<div>").attr("id",this.overlayId),$("body").append(this.overlay)),$("body").append(this.modal),_.bindAll(this,"hide"),this.options.closeable&&(this.closeBtn=this.modal.find(".close-x, .close, .skip"),this.closeBtn.live("click touchend",this.hide))},hide:function(e){if(e){if("keydown"==e.type){if(27!=e.keyCode)return;$(window).unbind("keydown.modal")}e.preventDefault()}return this.overlay.hide(),this.modal.hide(),this.options.hide&&this.options.hide(),this},show:function(){return this.overlay.show(),this.modal.show(),this.options.closeable&&(this.overlay.one("click",this.hide),$(window).bind("keydown.modal",this.hide)),this.options.show&&this.options.show(),this},visible:function(){return"none"!=this.modal.css("display")}}),s.Notify=s.Class.extend({initialize:function(){},clear:function(e){("string"==typeof e||"element"==typeof e)&&(e=$(e)),e.find(".flash").remove()},create:function(e,t){if(t.element){("string"==typeof t.element||"element"==typeof t.element)&&(t.element=$(t.element)),this.clear(t.element);var n=$(s.templates.render("layout/_flash",{message:e,type:t.type}));t.element.prepend(n),t.width&&n.width(t.width).addClass("borders"),t.slideSpeed=t.slideSpeed||200,_.defer(function(){n.slideDown(t.slideSpeed),t.duration&&_.delay(function(){n.slideUp(t.slideSpeed)},t.duration)})}},error:function(e,t){this.create(e,_.extend(t||{},{type:"error"}))},success:function(e,t){this.create(e,_.extend(t||{},{type:"success"}))},warning:function(e,t){this.create(e,_.extend(t||{},{type:"warning"}))},form:{removeError:function(e){$(e.currentTarget).removeClass("error").next(".error").remove()},clearValidationError:function(e){e.find("input").removeClass("error"),e.parent().find(".error, .success").remove()},validationError:function(e,t){var n=this;n.clearValidationError(t),_.isUndefined(e.fields)||(_.each(e.fields,function(e,r){t.find("input[name="+r+"]").unbind("keypress").one("keypress",_.bind(n.removeError,n)).addClass("error").after('<div class="error under">'+e+"</div>")}),t.find("input.error:first").select(),e.message="Fix any errors with the fields below."),s.notify.error(e.message,{element:t.parent()})}}}),$(function(){s.notify=new s.Notify}),s.Auth=s.Class.extend({initialize:function(e){this.setOptions(e),$(".login-main").show(),this.el={login:$("#login form"),loginButtons:$("#login .buttons"),loginUsername:$("#login-username"),loginPassword:$("#login-password"),loginStay:$("#login-stay"),loginSubmit:$("#login-submit"),signup:$("#signup form"),follow_storify:$("#follow-storify-container"),signupUsername:$("#signup-username"),signupEmail:$("#signup-email"),signupPassword:$("#signup-password"),signupSubmit:$("#signup-submit"),forgot:$("#recover form"),forgotEmail:$("#forgot-password-email"),forgotSubmit:$("#forgot-password-submit"),reset:$("#reset form"),usersList:$("#friends #users"),header:$("#friends .header"),filterLink:$("#friends .filter a"),follow:$("#friends #users .user button"),followAll:$("#subscribe-to-all"),showLogin:$("#login .showForm"),logout:$("#logout"),captchaSubmit:$("#captcha-submit")},this.next=s.utils.getUrlParams("next")||"/",this.popup="true"==s.utils.getUrlParams("popup"),/^(?:\/(?:[^\/]|$)|https?:\/\/.*\.?storify\.com(?:\/|$))/i.test(this.next)||(this.next="/"),this.cookieName="user","production"!==s.env&&(this.cookieName=s.env+"-"+this.cookieName);var t=s.store.get("user"),n=s.cookie.get(this.cookieName);if(null!=n)if(t&&t.username===n.username)this.setUser(t);else if(n._id)this.setUser(n),this.setUserCookie();else if(""==n)s.cookie.remove(this.cookieName),s.cookie.remove(this.cookieName,".storify.com");else{var r=this;$.getJSON("/currentUser",function(e){!e||e.error?(s.cookie.remove(r.cookieName),s.cookie.remove(r.cookieName,".storify.com")):(s.store.set("user",e),window.location.reload())})}else t&&s.store.remove("user");if(this.el.signup.length&&(s.everyauth.twitter||s.everyauth.facebook)&&this.showSignup(this.loginCallback),$("input").length>0&&$("input").first().focus(),$("#friends").length>0){var i=s.utils.getUrlParams("service")||"facebook";$("a.tab[rel="+i+"]").addClass("active"),$(".skip").attr("href",decodeURIComponent(this.next)),this.displayFriends(i)}this.addNextParam(),this.bind()},bind:function(){var e=this;_.bindAll(this,"login","logout","signupSubmit","signup","forgotPassword","resetPassword","getIdentity","displayFriends","filterLinkClicked","followHoverIn","followHoverOut","followClick","followAll","showLoginForm","submitCaptcha"),this.captchaModal=s.Modal?new s.Modal("#recaptcha",{closeable:!1}):{},this.el.login.bind("submit",this.login),this.el.signup.bind("submit",this.signupSubmit),this.el.forgot.bind("submit",this.forgotPassword),this.el.reset.bind("submit",this.resetPassword),$("#storify-auth .button.twitter").bind("click",function(t){t.preventDefault(),e.serviceAuth("twitter",{height:635})}),$("#storify-auth .button.facebook").bind("click",function(t){t.preventDefault(),e.serviceAuth("facebook")}),this.el.filterLink.bind("click",this.filterLinkClicked),this.el.follow.live("mouseenter",this.followHoverIn),this.el.follow.live("mouseleave",this.followHoverOut),this.el.follow.live("click",this.followClick),this.el.followAll.live("click",this.followAll),this.el.showLogin.click(this.showLoginForm),this.el.logout.click(this.logout),this.el.captchaSubmit.click(this.submitCaptcha)},showLoginForm:function(e){e.preventDefault(),this.el.showLogin.hide(),this.el.login.slideDown()},follow:function(e,t,n){var r=this,i="undefined"==typeof n?"add":n?"remove":"add";if(!r.user)return t(new Error("Not authenticated"));var o="/users/"+r.user.username+"/subscriptions/"+i;s.api.request("POST",o,{user:e,username:r.user.username,_token:r.user._token},{},function(e,n){return e?t(e.error.message):(t(null,n),void 0)})},unfollow:function(e,t){this.follow(e,t,!0)},getIdentity:function(e,n){if(!this.user||!e)return n(null);if(this.user.identities){var r=this.user.identities[e];if(n&&r)return n(r)}var i=this,o="/users/"+i.user.username+"/identities";s.api.request("GET",o,{username:i.user.username,_token:i.user._token},{},function(r,o){if(r)return s.notify.error(t(r.error.message),{element:"#content",slideSpeed:200,duration:15e3});var a=o.content;i.user.identities=i.user.identities||{};for(var l in a){var u=a[l];i.user.identities[u.service]=u}n(i.user.identities[e])})},serviceSignup:function(e){this.el.signupUsername.val(this.serviceData(e).username),this.showSignup(this.loginCallback)},serviceAuth:function(e,n){var r=this;n=$.extend({login:!0,popup:!0,width:800,height:400},n);var i=screen.width/2-n.width/2,o=screen.height/2-n.height/2,a="/auth/"+e+"?"+$.param(n);$.oauthpopup({path:a,windowOptions:"location=0,status=0,width="+n.width+",height="+n.height+",left="+i+",top="+o,callback:function(){s.everyauth=s.ea&&s.utils.parseJSON(s.ea)||{},s.everyauth[e]&&s.everyauth[e].accessToken?r.serviceLogin(e):r.validationError({message:t("Log in to __service__ denied",{service:e})},r.el.login)}})},showCaptcha:function(e){"function"==typeof e&&(this.captchaSubmitCallback=e),Recaptcha.reload(),this.el.captchaSubmit.removeAttr("disabled"),this.captchaModal.show(),$("#recaptcha input[name=recaptcha_response_field]").focus()},submitCaptcha:function(e){e.preventDefault();var n=$("#recaptcha input[name=recaptcha_challenge_field]"),r=$("#recaptcha input[name=recaptcha_response_field]");return r.val()?"function"!=typeof this.captchaSubmitCallback?(s.notify.error(t("Something weird happened. Please reload and try again."),{element:$("#recaptcha"),duration:4e3}),void 0):(this.el.captchaSubmit.attr("disabled",!0),this.captchaSubmitCallback({challenge:n.val(),response:r.val()}),void 0):(s.notify.error(t("Please fill in the captcha"),{element:$("#recaptcha"),duration:4e3}),void 0)},serviceData:function(e,t){var n=s.everyauth[e];return n&&"undefined"!=typeof n||(s.raven&&s.raven.started&&s.raven.Raven.captureMessage("auth.js:263. auth not defined? Service: "+JSON.stringify(e)+". s.everyauth: "+JSON.stringify(s.everyauth)+". s.ea : "+JSON.stringify(s.ea)),s.everyauth=s.ea&&s.utils.parseJSON(s.ea)||{},n=s.everyauth[e],n&&"undefined"!=typeof n)?{token:n.accessToken,secret:n.accessTokenSecret,service:e,service_userid:n.user.id,username:n.user.screen_name||n.user.username||n.user.id||n.user.email||(n.user.firstName?n.user.firstName+" "+n.user.lastName:void 0),name:n.user.name||n.user.full_name||(n.user.firstName?n.user.firstName+" "+n.user.lastName:void 0),email:n.user.email,avatar:n.user.profile_picture||n.user.photo,bio:n.user.description||n.user.bio,location:"object"==typeof n.user.location?n.user.location.name:n.user.location,website:n.user.url||(n.user.website?n.user.website.split("\n")[0]:void 0),captcha:t&&JSON.stringify(t)}:(s.raven&&s.raven.started&&s.raven.Raven.captureMessage("auth.js:269. auth still not defined? Service: "+JSON.stringify(e)+". s.everyauth: "+JSON.stringify(s.everyauth)),{})},serviceLogin:function(e,t,n){var r=this,i=this.el.loginStay.attr("checked"),n=n||function(){};if(s.everyauth[e]&&s.everyauth[e].accessToken){var o="/auth/"+e;s.api.request("POST",o,r.serviceData(e,t),{},function(t,o){if(t)t.error&&"no_identity"==t.error.type?r.el.signup.length>0?r.serviceSignup(e):window.location.href=s.base_url+"/signup?next="+r.next:(r.validationError(t.error,r.el.login),r.logout()),n(t.error);else{r.clearValidationError(r.el.login);var a=o.content;r.setUser(a),r.setUserCookie(i),r.el.loginUsername.val(""),r.el.loginPassword.val(""),r.el.loginSubmit.removeAttr("disabled"),r.popup&&window.opener?r.close():window.location.href=decodeURIComponent(r.next),n()}})}else this.serviceAuth(e)},serviceConnect:function(e,t){var n=this;analytics.track("registration",{event:"auth-serviceConnect",service:e}),$.oauthpopup({path:"/auth/"+e,callback:function(){return s.everyauth=s.utils.parseJSON(s.ea),n.addIdentity(e,t)}})},serviceReconnect:function(e,t){var n=this;$.oauthpopup({path:"/auth/"+e,callback:function(){s.everyauth=s.utils.parseJSON(s.ea),s.everyauth[e]&&s.everyauth[e].accessToken?t(s.everyauth[e]):n.validationError({message:"Log in to "+e+" denied."},n.el.login)}})},serviceDisconnect:function(e,t){this.removeIdentity(e,t)},addIdentity:function(e,n,r){var i=this;"function"!=typeof n||r||(r=n,n=null);var o=this.serviceData(e);n&&(o.options=JSON.stringify(n)),o._token=this.user._token;var a="/users/"+s.auth.user.username+"/identities/add?username="+encodeURIComponent(this.user.username);s.api.request("POST",a,o,{},function(n,o){if(n){var a=n.error;if("duplicate_identity"==a.type&&a.message){msg=a.message;var l=s.utils.lastWord(msg);if("user"!==l){var u='<a href="'+s.base_url+"/"+l+' " target="_blank"> '+l+" </a>";msg=msg.replace(l,u)}}else msg="Failed to connect "+e+" account.";return s.notify.error(t(msg),{element:"#content",slideSpeed:200,duration:15e3})}i.user.identities=i.user.identities||{},i.user.identities[e]=o.content.identity,r&&r(o)})},removeIdentity:function(e,n){var r="/users/"+s.auth.user.username+"/identities/remove";s.api.request("POST",r,{identity:JSON.stringify({service:e}),username:this.user.username,_token:this.user._token},{},function(r,i){r?n(r):(s.notify.success(t("Successfully unlinked __service__ account",{service:e}),{element:"#content",slideSpeed:200,duration:3e3}),n(i))})},showSignup:function(){var e=this;e.el.signup.parent().find(".buttons, .or").show(),s.everyauth.twitter&&s.everyauth.twitter.user?(e.el.signup.parent().find(".buttons, .or").hide(),e.el.signup.find(".twitter-user").remove(),e.el.signup.prepend(s.templates.render("everyauth/_twitter_user",{user:s.everyauth.twitter.user})),e.el.signupUsername.val(s.everyauth.twitter.user.screen_name),e.el.follow_storify.removeClass("hidden"),e.el.signupEmail.focus()):s.everyauth.facebook&&s.everyauth.facebook.user&&(e.el.signup.parent().find(".buttons, .or").hide(),e.el.signup.find(".facebook-user").remove(),e.el.signup.prepend(s.templates.render("everyauth/_facebook_user",{user:s.everyauth.facebook.user})),e.el.signupUsername.val(s.everyauth.facebook.user.username),e.el.signupEmail.val(s.everyauth.facebook.user.email),s.everyauth.facebook.user.username?e.el.signupPassword.focus():e.el.signupUsername.focus()),setTimeout(function(){s.notify.success(t("Your Storify account is almost ready!"),{element:e.el.signup.parent(),duration:4e3})},1e3)},showLogin:function(e){this.loginCallback=e},loginPopup:function(e){var t=this,n=400,r=480,i=screen.width/2-n/2,o=screen.height/2-r/2;$.oauthpopup({windowName:"Login",windowOptions:"location=0,status=0,width="+n+",height="+r+",top="+o+",left="+i,path:"/login?popup=true",callback:function(n){return n?e(n):($.getJSON("/currentUser",function(r){return r.error?e(r.error):(t.setUser(r),s.nav&&s.nav.updateUser(),e(n,r),void 0)}),void 0)}})},signupSubmit:function(e){e.preventDefault();for(var n=$("#signup form:first").find("input"),r=0;r<n.length;r++){var i=$(n[r]);if(!i.val()&&"checkbox"!==i.attr("type"))return i.focus(),this.validationError({message:t("Please enter the")+" "+i.attr("name")+" "+t("field")},this.el.signup),void 0}var s=this.el.signup.find("input[name=agree]");return s.attr("checked")?(this.showCaptcha(this.signup),void 0):(s.focus(),this.validationError({message:t("Please agree to the terms of service")},this.el.signup),void 0)},signup:function(e){var t,n=this,r=(this.el.signup.find("input[name=agree]").attr("checked"),this.el.signup.find("input[name=username]").val()),i=this.el.signup.find("input[name=email]").val(),o=this.el.signup.find("input[name=password]").val(),a={username:r,email:i,password:o};if(s.everyauth.twitter&&s.everyauth.twitter.user)t="twitter",a=_.extend(a,{bio:s.everyauth.twitter.user.description,avatar:s.everyauth.twitter.user.profile_image_url.replace("_normal","_reasonably_small"),website:s.everyauth.twitter.user.url,name:s.everyauth.twitter.user.name,location:s.everyauth.twitter.user.location,service:"twitter"});else if(s.everyauth.facebook&&s.everyauth.facebook.user){t="facebook",a=_.extend(a,{bio:s.everyauth.facebook.user.bio,avatar:"http://graph.facebook.com/"+(s.everyauth.facebook.user.username||s.everyauth.facebook.user.id)+"/picture",name:s.everyauth.facebook.user.name,service:"facebook"});var l=s.everyauth.facebook.user.location,u=s.everyauth.facebook.user.website;l&&(a.location=l.name),u&&(a.website=u.split("\n")[0])}this.setRaven(),n.el.signupSubmit.attr("disabled",!0);var c="/users/create";s.api.request("POST",c,{user:JSON.stringify(a),captcha:JSON.stringify(e)},{retryLimit:3},function(e,r){function i(){window.location.href=s.base_url+"/friends?service="+t+"&next="+decodeURIComponent(n.next)}if(e)n.validationError(e.error,n.el.signup),n.el.signupSubmit.removeAttr("disabled"),n.el.captchaSubmit.removeAttr("disabled"),e.error&&"captcha_failed"!=e.error.type?n.captchaModal.hide():n.showCaptcha();else{n.clearValidationError(n.el.signup);var o=r.content;n.setUser(o),n.setUserCookie(!0),n.el.signupSubmit.removeAttr("disabled"),t?"twitter"==t?n.addIdentity("twitter",{follow_storify:"checked"==n.el.follow_storify.find("#follow-storify").attr("checked")},i):"facebook"==t&&n.addIdentity("facebook",i):window.location.href=decodeURIComponent(n.next)}})},forgotPassword:function(e){e.preventDefault();var n=this,r=this.el.forgot.find("#forgot-password-email").val();this.el.forgot.find("input, button").attr("disabled",!0);var i="/auth/forgot_password",o={email:r};s.api.request("POST",i,o,{},function(e){e?(n.validationError(e.error,n.el.forgot.find("form")),n.el.forgot.find("input, button").removeAttr("disabled")):(n.clearValidationError(n.el.forgot),n.el.forgotEmail.val(""),n.el.forgotSubmit.removeAttr("disabled"),s.notify.success(t("You should receive an email shortly"),{element:$("body")}))})},resetPassword:function(e){e.preventDefault();var n=this,r=this.el.reset.find("#reset-password-password").val(),i=s.utils.getQueryString(window.location.search.substr(1).split("&"));this.el.reset.find("input, button").attr("disabled",!0);var o="/auth/reset_password",a={password:r,email:i.email,reset_token:i.reset_token};s.api.request("POST",o,a,{},function(e){e?(n.validationError(e.error,n.el.reset),n.el.reset.find("input, button").removeAttr("disabled")):(n.clearValidationError(n.el.reset),s.notify.success(t("Your password has been reset")+".",{element:$("body")}),setTimeout(function(){window.location.href=s.base_url+"/"},1e3))})},login:function(e){e.preventDefault();var t=this,n=this.el.loginUsername.val(),r=this.el.loginPassword.val(),i=this.el.loginStay.attr("checked");this.setRaven(),this.el.loginSubmit.attr("disabled",!0);var o="/auth",a={username:n,password:r};s.api.request("POST",o,a,{retryLimit:3},function(e,n){if(e)t.validationError(e.error,t.el.login),t.el.loginSubmit.removeAttr("disabled");else{t.clearValidationError(t.el.login);var r=n.content;t.setUser(r),t.setUserCookie(i),t.el.loginUsername.val(""),t.el.loginPassword.val(""),t.el.loginSubmit.removeAttr("disabled"),t.popup&&window.opener?t.close():window.location.href=decodeURIComponent(t.next)}})},close:function(){window.opener.s||(window.opener.s={}),window.opener.s.ea=JSON.stringify(s.everyauth),window.opener.s.embedUser=JSON.stringify(this.user),window.close()},setUser:function(e){this.user=e;var t={username:e.username,email:e.email,created:e.date?e.date.created:null,bio:e.bio,lang:e.lang,location:e.location,firstname:e.name,plan:e.paid_plan};e._stripe&&(e._stripe.next_recurring_charge&&(t.next_billing=e._stripe.next_recurring_charge.date,t.amount=e._stripe.next_recurring_charge.amount),t.canceled=e._stripe.dates.cancelled_at,t.plan_id=e._stripe.plan.id,t.period=e._stripe.plan.interval),this.setRaven(e),analytics.identify(e._id,t)},setRaven:function(e){s.raven?s.raven.start&&s.raven.start():s.raven={},s.raven&&s.raven.started&&e&&s.raven.Raven.setUser({username:e.username,id:e._id,plan:e.paid_plan,email:e.email})},setIntercom:function(){return!1},setUserCookie:function(e){var t={username:this.user.username,_token:this.user._token,reloadSession:!0},n={domain:".storify.com",secure:"development"!==s.env};if("development"!=s.env&&(n.secure=!0),e){var r=new Date;r.setTime(r.getTime()+2592e6),n.expires=r}s.cookie.set(this.cookieName,t,n),s.store.set("user",this.user),$.i18n&&$.i18n.setLng(this.user.lang),this.loginCallback&&this.loginCallback(),this.loginCallback=null},logout:function(){this.user=null,s.everyauth={},s.cookie.remove(this.cookieName),s.cookie.remove(this.cookieName,".storify.com"),s.store.remove("user"),s.raven.stop()},removeError:function(e){$(e.currentTarget).removeClass("error").next(".error").remove()},clearValidationError:function(e){e.find("input").removeClass("error"),e.parent().find(".error, .success").remove()},validationError:function(e,n){var r=this;return this.clearValidationError(n),e?(_.isUndefined(e.fields)||(_.each(e.fields,function(e,t){n.find("input[name="+t+"]").unbind("keypress").one("keypress",_.bind(r.removeError,r)).addClass("error").after('<div class="error under">'+e+"</div>")}),n.find("input.error:first").select(),e.message="Fix any errors with the fields below"),s.notify.error(t(e.message),{element:$("body"),duration:4e3}),void 0):s.notify.error(t("Something wrong happened, please try again."),{element:$("body"),duration:4e3})},addNextParam:function(){var e=this;$("a.next").each(function(t,n){var r=$(n).attr("href");$(n).attr("href",r+"?next="+e.next)})},displayFriends:function(e){var n={},r=this;if(!e||"undefined"==typeof e)return s.raven&&s.raven.started&&s.raven.Raven.captureMessage("auth.js:819. No service? : "+JSON.stringify(e)),void 0;r.el.usersList.empty(),r.el.usersList.append('<div class="loading"></div>'),r.el.header.hide(),r.user&&(n.username=r.user.username,n._token=r.user._token);var i="/users/"+n.username+"/friends/"+e;s.api.request("GET",i,n,{},function(n,i){if(n){var o=e.charAt(0).toUpperCase()+e.slice(1);r.el.usersList.find(".loading").remove(),r.el.usersList.append('<p class="empty">'+t("Your account is not connected to ")+o+".</p>")}else{r.el.usersList.find(".loading").remove();var a=i.content.friends;if(a&&a.length>0)for(var l=0;l<a.length;l++){var u=s.templates.render("user/_user",{s_user:a[l],s_auth_user:r.user});r.el.usersList.append(u),r.el.header.show()}else r.el.usersList.append('<p class="empty">'+t("Couldn't find any of your friends on Storify.")+"</p>")}})},filterLinkClicked:function(e){e.preventDefault();var t=$(e.target),n=t.attr("rel");this.el.filterLink.removeClass("active"),t.addClass("active"),this.displayFriends(n)},followHoverIn:function(e){var n=$(e.target).parents(".user").find("button");n.hasClass("cancel")&&n.removeClass("cancel").addClass("decline").html("<span>✖ "+t("Unsubscribe")+"</span>")},followHoverOut:function(e){var n=$(e.target).parents(".user").find("button");n.hasClass("decline")&&n.removeClass("decline").addClass("cancel").html("<span>✔ "+t("Subscribed")+"</span>")},followClick:function(e){var n=$(e.target).parents(".user").find("button"),r=n.parents(".user").attr("data-username");n.attr("disabled",!0),n.hasClass("accept")?(n.html("<span>"+t("Subscribing")+"</span>"),s.auth.follow(r,function(e){return n.removeAttr("disabled").html("<span>✚ "+t("Subscribe")+"</span>"),e?(s.notify.error(t("Unable to subscribe to __name__ at this time, please try again later",{name:r}),{element:"body",duration:4e3}),void 0):(n.removeClass("accept").addClass("cancel").html("<span>✔ "+t("Subscribed")+"</span>"),void 0)})):(n.html("<span>"+t("Unsubscribing")+"</span>"),s.auth.unfollow(r,function(e){return n.removeAttr("disabled").html("<span>✔ "+t("Subscribed")+"</span>"),e?(s.notify.error(t("Unable to unsubscribe from __name__ at this time, please try again later",{name:r}),{element:"body",duration:4e3}),void 0):(n.removeClass("cancel decline").addClass("accept").html("<span>✚ "+t("Subscribe")+"</span>"),void 0)
}))},followAll:function(){this.el.usersList.find("button.accept").each(function(e,t){t.click()})}}),$(function(){s.auth=new s.Auth}),s.Embed=s.Class.extend({initialize:function(){var e=this;$(window).bind("message",_.bind(this.onMessage,this)),this.height=0,this.isEmbed=!!window.location.href.match("/embed"),this.isHtml=!!window.location.href.match(".html");var t=window.location!=window.parent.location?document.referrer:document.location;t.href&&(t=t.href),this.isOnStorify=t.match(/storify.com/)?!0:!1,this.showedPostTooltip=!1,_.bindAll(this,"sendEmail","changeEmbedCode","loadMore","resize","elementClick","activateLike","deactivateLike","likeError","likeButtonLiked","likeButtonUnliked","bottomLinkClicked","bottomLikeClicked","subscribeButtonClicked","elementCommentSubmit","elementCommentMore","elementCommentButtonClicked","elementShareButtonClicked","elementCommentMoreText","commentPostToggle","elementShareDropdownHide","shareButtonClicked","share","pin","elementLikeButtonClicked","elementLike","elementUnlike","elementCommentRemove","commentSubmit","commentsMore","commentRemove","commentTextMore","activateComment","animateBigLike","showFocus","hideFocus","commentInputKeydown","elementStorypadAdd","embedLikeButtonClicked","embedLike","embedUnlike","linkClick"),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow(),!0)}),this.commentDropdown=new s.Dropdown(".s-header .s-actions a.comment","#s-comment-dropdown",{activate:this.activateComment}),this.shareDropdown=new s.Dropdown(".s-header .s-actions a.share","#s-share-dropdown"),this.embedDropdown=new s.Dropdown(".s-header .s-actions a.embed","#s-embed-dropdown"),this.embedShareDropdown=new s.Dropdown(".f-actions a.share","#share-footer-dropdown"),this.likeButton=new s.Button(".s-header .s-actions a.like",{toggle:!0,activate:this.activateLike,deactivate:this.deactivateLike,activeClass:"active"}),this.embedLikeButton=new s.Button(".f-actions a.like",{toggle:!0,activate:this.activateLike,deactivate:this.deactivateLike,activeClass:"active"}),this.el={body:$("body"),storyContainer:$("#story"),story:$(".s-story"),emailSend:$("#s-email-send"),emailFrom:$("#s-email-from"),emailTo:$("#s-email-to"),emailResultSuccess:$(".s-email-result .success"),emailResultError:$(".s-email-result .error"),embedCode:$("#s-embed-code"),embedCodeDist:$("#s-embed-code-dist"),embedCopy:$("#s-copy-code"),embedTemplate:$("#s-embed-template"),embedHeader:$("#s-show-header"),embedBorder:$("#s-show-border"),embedSharing:$("#s-show-sharing"),embedSEOContainer:$(".s-embed-seo"),embedSEO:$("#s-show-seo"),embedOptions:$(".s-embed-options input, .s-embed-options select"),embedShowOptions:$(".s-embed-show"),loadMore:$(".s-load-more"),elementsList:$(".s-elements"),element:$(".s-element"),elementQuote:$(".s-element-quote"),elementShareLabel:$(".s-element-share-label"),elementCommentInput:$(".element-comment-input"),elementCommentMore:$(".element-comment-more"),elementCommentButton:$(".s-element .buttons .comment"),elementCommentRemove:$(".comments .comment a.remove"),elementCommentMoreText:$(".comments .comment a.moreComment"),elementCommentPostButton:$(".element-comment-post i"),elementStats:$(".s-element .s-element-stats"),elementShareButton:$(".s-element .buttons a.share"),elementShareDropdown:$(".s-share-dropdown"),elementLikeButton:$(".s-element a.like"),likeButton:$(".s-header .s-actions a.like"),commentButton:$(".s-header .s-actions a.comment"),bottomLink:$(".more-on-storify"),bottomLike:$(".engage .intro .like"),bottomLiked:$(".engage .liked"),bottomComment:$(".engage .comment"),bottomActionContainer:$(".engage .action-container"),bottomCommentInput:$(".engage .story-comment-input"),subscribeButton:$(".subscribe-button"),subscribeLabel:$(".subscribe-label"),subscribedLabel:$(".subscribed-label"),shareButton:$(".s-actions-share a"),comments:$("#comments .previous ul, .engage .previous ul"),commentsMore:$("#comments .more, .engage .more"),commentsNum:$("#comments .story-comment-n, .engage .story-comment-n"),commentsInput:$("#comments input, .story-comment-input"),commentRemove:$("#comments .comment .remove, .engage .comment .remove"),commentNotSpam:$("#comments .comment .notSpam, .engage .comment .notSpam"),commentMore:$("#comments .comment .moreComment, .engage .comment .moreComment"),bigLike:$("#big-like"),commentPostButton:$(".story-comment-post i"),storyCommentInput:$(".story-comment-input"),embedLikeButton:$(".f-actions a.like"),title:$(".s-title"),description:$(".s-description"),elementsText:$(".s-text"),elementsHeaderText:$(".s-text h2"),linkText:$(".s-text a")};var n="#ffffff";if(!this.isOnStorify&&(this.isEmbed||this.isHtml)&&s.story.author.style){var r=s.story.author.style,i=null,o=null;r&&r.typekit&&!_.isEmpty(r.typekit.fonts)&&(i=_.where(r.typekit.fonts[0].families,{name:r.fonts.body}),o=_.where(r.typekit.fonts[0].families,{name:r.fonts.title})),this.el.title.css("font-family",_.isEmpty(o)?r.fonts.title:o[0].css_stack),this.el.description.css("font-family",_.isEmpty(i)?r.fonts.body:i[0].css_stack),this.el.elementsText.css("color",r.colors.text),this.el.elementsText.css("font-family",_.isEmpty(i)?r.fonts.body:i[0].css_stack),this.el.elementsHeaderText.css("color",r.colors.text),this.el.elementsHeaderText.css("font-family",_.isEmpty(i)?r.fonts.body:i[0].css_stack),this.el.linkText.css("color",r.colors.link),n=r.colors.background,$(".s-story, .s-element-content.s-text").css("background-color",r.colors.background)}if($(".s-story .s-header-top").css("background-color",n),s.story.author.options&&s.story.author.options.ga&&s.story.author.ga_tracker&&_gaq.push(["b._setAccount",s.story.author.ga_tracker],["b._trackPageview"]),$.fn.tipsy&&(this.el.commentPostButton.tipsy({gravity:$.fn.tipsy.autoBounds(100,"s"),fade:!0,delayIn:500}),this.el.elementCommentPostButton.tipsy({gravity:$.fn.tipsy.autoBounds(100,"s"),fade:!0,delayIn:500,live:!0}),$(".s-actions a, .actions a").tipsy({gravity:$.fn.tipsy.autoBounds(100,"s"),fade:!0,delayIn:500,live:!0})),this.path=s.user.username+"/"+s.story.slug,this.per_page=25,this.page=2,this.has_feature=function(e,t){switch(e){case"liveUpdate":setTimeout(function(){return s.story.author.features_enabled.realtime_updates?t(!0):window.location.href.match("/embed")?void 0:t(!0)},1e3,t);break;case"infinite_scroll":var n=(s.story.author.settings?s.story.author.settings.options:s.story.author.options)||{};if(n.infinite_scroll)return t(!0)}},this.el.elementsList.children().length<this.per_page&&this.el.loadMore.remove(),s.auth.user?(this.el.emailFrom.val(s.auth.user.email),(s.auth.user._access>0||-1!=["ajstream","bilalr"].indexOf(s.auth.user.username))&&this.el.embedSEOContainer.show(),s.auth.getIdentity("facebook",function(e){s.auth.getIdentity("twitter",function(t){e&&s.auth.user.settings.facebook_post&&$(".story-comment-facebook, .element-comment-facebook").addClass("active"),t&&s.auth.user.settings.twitter_post&&$(".story-comment-twitter, .element-comment-twitter").addClass("active")})})):$("body").hasClass("touch")&&!this.isEmbed&&(this.el.commentButton.hide(),this.el.commentButton.siblings(".comment-count").hide(),this.el.likeButton.hide(),this.el.likeButton.siblings(".like-count").hide(),this.el.elementLikeButton.hide(),this.el.elementCommentButton.hide(),this.el.elementStats.hide(),$("#messages").append('<div class="message">Login to engage with this story</div>')),this.embedCodeTemplate='<div class="storify"><iframe src="{{base}}/{{username}}/{{slug}}/embed{{options}}" width="100%" height="750" frameborder="no" allowtransparency="true"></iframe><script src="{{base}}/{{username}}/{{slug}}.js{{options}}"></script><noscript>[<a href="{{base}}/{{username}}/{{slug}}" target="_blank">View the story "{{title}}" on Storify</a>]',this.changeEmbedCode(),this.el.emailSend.click(this.sendEmail),this.el.embedOptions.change(this.changeEmbedCode),this.el.embedCode.click(this.embedCodeClick),this.el.embedCodeDist.click(this.embedCodeClick),this.el.loadMore.click(this.loadMore),this.el.bottomLink.click(this.bottomLinkClicked),this.el.bottomLike.click(this.bottomLikeClicked),this.el.bottomComment.click(this.bottomCommentClicked),this.el.bottomCommentInput.bind("focus",function(t){e.showFocus(t)}),this.el.bottomCommentInput.bind("blur",this.hideFocus),this.el.subscribeButton.click(this.subscribeButtonClicked),this.el.elementCommentMore.live("click",this.elementCommentMore),this.el.elementCommentInput.live("keydown",this.commentInputKeydown),this.el.elementCommentInput.live("keypress",this.elementCommentSubmit),this.el.elementCommentButton.live("click",this.elementCommentButtonClicked),this.el.elementCommentRemove.live("click",this.elementCommentRemove),this.el.elementCommentMoreText.live("click",this.elementCommentMoreText),this.el.elementCommentPostButton.live("click",this.commentPostToggle),this.el.elementStats.live("click",this.elementCommentButtonClicked),this.el.elementCommentInput.live("focus",this.showFocus),this.el.elementCommentInput.live("blur",this.hideFocus),this.commentsPerPage=10,this.commentsPage=2,this.commentsNum=s.story.stats.comments-this.commentsPerPage,this.el.commentsInput.keydown(this.commentInputKeydown),this.el.commentsInput.keypress(this.commentSubmit),this.el.commentsMore.click(this.commentsMore),this.el.commentRemove.live("click",this.commentRemove),this.el.commentNotSpam.live("click",this.commentNotSpam),this.el.commentMore.live("click",this.commentTextMore),this.el.commentPostButton.live("click",this.commentPostToggle),this.el.commentsInput.bind("focus",this.showFocus),this.el.commentsInput.bind("blur",this.hideFocus),this.el.body.click(this.elementShareDropdownHide),this.el.elementShareButton.live("click",this.elementShareButtonClicked),this.el.elementLikeButton.live("click",this.elementLikeButtonClicked),this.el.shareButton.live("click",this.shareButtonClicked),$(".twitter-reply").live("click",function(){analytics.track("engagement-share",{event:"twitter-reply",context:"embed-local",source:"twitter"})}),$(".twitter-retweet").live("click",function(){analytics.track("engagement-share",{event:"twitter-retweet",context:"embed-local",source:"twitter"})}),$(".s-text a").live("click",this.linkClick),/^#[0-9a-z]{6}$/.test(window.location.hash)&&$(window).load(function(){e.linkClick(window.location.hash)}),s.story.liked&&this.likeButtonLiked(!0),this.has_feature("liveUpdate",function(){var t=(new Date).getTime()-new Date(s.story.date.published).getTime();36e5>t&&e.pollPerseids()}),e.resize(),$(window).load(function(){e.ensureResize()}),$("body").hasClass("touch")){var a;this.el.elementQuote.find(".s-element-actions").css("opacity",1),this.el.elementQuote.hammer&&this.el.elementQuote.hammer({drag:!1})&&this.el.elementQuote.hammer({drag:!1}).bind&&this.el.elementQuote.hammer({drag:!1}).bind("tap",function(e){var t=$(e.target).find(".actions");t.show(),clearTimeout(a),a=setTimeout(function(){t.hide()},5e3)})}e.render()},pollPerseids:function(){function e(){$.ajax({url:s.perseids+"/await/",data:{resource:"urn:storify:"+s.story.sid+":"+s.story.version},dataType:"json",success:function(n){if(n.timeout)return e();if("error"===n.status)return setTimeout(e,1e3);var r=s.story.version;t.reload(function(t){return t?setTimeout(e,1e3):s.story.version===r?setTimeout(e,5e3):(e(),void 0)})},error:function(){setTimeout(e,1e3)}})}var t=this;e()},renderText:function(){if(!this.isOnStorify&&(this.isEmbed||this.isHtml)&&s.story.author.style){var e=s.story.author.style,t=null,n=null;e&&e.typekit&&!_.isEmpty(e.typekit.fonts)&&(t=_.where(e.typekit.fonts[0].families,{name:e.fonts.body}),n=_.where(e.typekit.fonts[0].families,{name:e.fonts.title})),this.el.elementsText=$(".s-text"),this.el.elementsHeaderText=$(".s-text h2"),this.el.linkText=$(".s-text a"),this.el.title.css("font-family",_.isEmpty(n)?e.fonts.title:n[0].css_stack),this.el.description.css("font-family",_.isEmpty(t)?e.fonts.body:t[0].css_stack),this.el.elementsText.css("color",e.colors.text),this.el.elementsText.css("font-family",_.isEmpty(t)?e.fonts.body:t[0].css_stack),this.el.elementsHeaderText.css("color",e.colors.text),this.el.elementsHeaderText.css("font-family",_.isEmpty(t)?e.fonts.body:t[0].css_stack),this.el.linkText.css("color",e.colors.link),$(".s-story, .s-element-content.s-text").css("background-color",e.colors.background)}},renderAnchorLinks:function(){this.isOnStorify&&this.el.story.find("h1[id], h2[id]").not(":has(a.storifycon-source-link)").each(function(){$("<a>").attr("href","#"+this.id).attr("title","Click to link to this header").addClass("storifycon-source-link").tipsy({fade:!0,gravity:$.fn.tipsy.autoBounds(20,"n")}).prependTo(this)})},renderTimestampTooltips:function(){this.el.story.find(".s-text [data-timestamp]:not([original-title])").each(function(){var e=$(this),t=moment(parseInt(e.attr("data-timestamp"))),n=t.toString().match(/\((.+?)\)/),r="in your timezone";n&&(r=n[1]),n=e.text().match(/\w+$/);var i=n&&n[0];r!==i&&e.attr("title",t.format("LLL")+" "+r).tipsy({fade:!0,gravity:$.fn.tipsy.autoBounds(20,"n")})})},renderExternalIframe:function(){if(!s.story.author.features_enabled.headerless_embed){var e=s.base_url;0===e.indexOf("//")&&(e=window.location.protocol+e),this.postMessage({method:"loadExternalNavIframe",value:{storyId:s.story.sid,html:s.templates.render("story/_pinned_header",{base_url:e,isEmbed:!0,isExternalNav:!0,story:s.story})}})}},render:function(){this.renderText(),this.renderAnchorLinks(),this.renderTimestampTooltips(),this.renderExternalIframe(),s.utils.emojify(),this.ensureResize()},ensureIdentity:function(e,t,n){var r=this;s.auth.user?s.auth.getIdentity(t,function(e){e?n(!0):s.auth.serviceConnect(t,function(e){n(!!e)})}):s.auth.loginPopup(function(i,s){!i&&s&&(r.postMessage({method:"login",value:s}),r.ensureIdentity(e,t,n))})},commentInputKeydown:function(e){if(s.cookie.get("postSeen"))return!0;s.cookie.set("postSeen",!0);var t=$(e.target).parents(".action-container").find(".element-comment-post, .story-comment-post");$.fn.tipsy&&(t.tipsy({trigger:"manual",html:!0,opacity:.95,fade:!0,fallback:'Press "enter" to submit your comment.<br />You can also toggle Twitter/Facebook sharing.',gravity:$.fn.tipsy.autoBounds(144,"ne"),offset:2}),t.tipsy("show"))},commentPostUpdateSetting:function(e,n){if(s.auth.user){var r={settings:{}};r.settings[e+"_post"]=n;var i="/users/"+s.auth.user.username+"/update",o={user:JSON.stringify(r),username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",i,o,{},function(e,n){e?s.notify.error(t("Error updating the user, please try again"),{element:"#container",duration:3e3}):(s.auth.setUser(n.content),s.auth.setUserCookie(),s.nav&&s.nav.updateUser())})}},commentPostToggle:function(e){var t=this,n=$(e.currentTarget),r=n.attr("data-service");n.hasClass("active")?(n.removeClass("active"),t.commentPostUpdateSetting(r,!1)):t.ensureIdentity(e,r,function(e){e&&(n.addClass("active"),t.commentPostUpdateSetting(r,!0))})},commentSubmit:function(e){if(13==e.keyCode){e.preventDefault();var t=this,n=$(e.currentTarget),r=n.val();$.fn.tipsy&&n.parents(".action-container").find(".element-comment-post, .story-comment-post").tipsy("hide"),r&&(s.auth.user?t.comment(n,r):s.auth.loginPopup(function(e,i){!e&&i&&(t.postMessage({method:"login",value:i}),t.comment(n,r))}))}},comment:function(e,n){var r=this,i=e.parent().find(".story-comment-facebook").hasClass("active"),o=e.parent().find(".story-comment-twitter").hasClass("active");e.prop("disabled",!0);var a="/stories/"+s.user.username+"/"+s.story.slug+"/comments/add",l={username:s.auth.user.username,_token:s.auth.user._token,comment:_.trim(n),published:!0,twitter:o,facebook:i};s.api.request("POST",a,l,{},function(n,i){if(n)e.val("").prop("disabled",!1),s.notify.error(t("Error posting the comment, please try again"),{element:"#container",duration:3e3});else{var o=s.templates.render("story/elements/_comment",{comment:i.content,prune:!1});r.el.comments.prepend(o),r.updateTimestamps(),e.val("").blur(),e.prop("disabled",!1),r.el.commentButton.removeClass("no-comment");var a=r.el.commentButton.find(".comment-count"),l=parseInt(a.html())+1;a.html(l),a.removeClass("hidden"),analytics.track("engagememt",{event:"story-comment",context:"embed-local",auth:!0,permalink:s.story.permalink})}})},commentsMore:function(e){var n=this;e.preventDefault(),n.el.commentsMore.addClass("loading");var r="/stories/"+s.user.username+"/"+s.story.slug+"/comments",i={per_page:n.commentsPerPage,page:n.commentsPage,username:s.auth.user.username,_token:s.auth.user._token,published:!0};s.api.request("GET",r,i,{},function(e,r){if(e)n.el.commentsMore.remove(),s.notify.error(t("Error retrieving the comments, please try again"),{element:"#container",duration:3e3});else{var i=r.content.comments;i.forEach(function(e){n.el.comments.append(s.templates.render("story/elements/_comment",{comment:e}))}),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow())}),n.commentsNum-=n.commentsPerPage,n.commentsPage++,n.commentsNum<=0?n.el.commentsMore.remove():(n.el.commentsNum.text(n.commentsNum),n.el.commentsMore.removeClass("loading")),n.updateTimestamps(n.el.comments)}})},commentTextMore:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".comment"),r=n.find(".content"),i=n.find(".fullContent");t.addClass("hide"),r.addClass("hide"),i.removeClass("hide")},commentRemove:function(e){e.preventDefault();var n=this,r=$(e.currentTarget),i=r.parents(".comment"),o=i.attr("data-id");if(confirm("Are you sure?")){var a="/stories/"+s.user.username+"/"+s.story.slug+"/comments/remove",l={username:s.auth.user.username,_token:s.auth.user._token,comment:o,published:!0};s.api.request("POST",a,l,{},function(e){if(e)s.notify.error(t("Error removing the comment, please try again"),{element:"#container",duration:3e3});else{$(".comment-"+o).remove();var r=n.el.commentButton.find(".comment-count"),i=parseInt(r.html())-1;r.html(i),0==i&&(n.el.commentButton.addClass("no-comment"),r.addClass("hidden"))}})}},commentNotSpam:function(e){if(e.preventDefault(),confirm("Are you sure?")){var n=$(e.currentTarget),r=n.parents(".comment"),i=r.attr("data-id"),o="/stories/"+s.user.username+"/"+s.story.slug+"/comments/not_spam",a={username:s.auth.user.username,_token:s.auth.user._token,comment:i,published:!0};s.api.request("POST",o,a,{},function(e){e?s.notify.error(t("Error un-spamming the comment, please try again"),{element:"#container",duration:3e3}):(r.removeClass("spam"),r.find(".notSpam").remove())})}},activateComment:function(){return _.defer(function(){$("#comments .story-comment-input").focus()}),!0},elementCommentMoreText:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".comment"),r=n.find(".content"),i=n.find(".fullContent");t.addClass("hide"),r.addClass("hide"),i.removeClass("hide")},elementStorypadAdd:function(e,t){var n={permalink:t,type:e},r={utm_medium:"storyPage",utm_content:e};this.isEmbed?this.postMessage({method:"storify",value:JSON.stringify(n)}):sfy&&sfy.showModal&&(n.via=s.story.permalink,s.auth.user?sfy.showModal(n,r):s.auth.loginPopup(function(e,t){!e&&t&&sfy.showModal(n,r)}))},elementLikeButtonClicked:function(e){var t=this,n=$(e.target);if(n.parents(".s-element"),e.preventDefault(),s.auth.user)t.elementToggleLike(e);else{var r=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"element-like",searchQuery:r,context:"embed-local",auth:!0,source:$elementInStory.attr("data-source")}),s.auth.loginPopup(function(n,r){!n&&r&&(t.postMessage({method:"login",value:r}),t.elementToggleLike(e))})}},elementToggleLike:function(e){var t=$(e.currentTarget);t.hasClass("active")?this.elementUnlike(t):this.elementLike(t)},elementLike:function(e){var n=this,r=e.parents(".s-element").attr("data-eid"),i=$(".s-element[data-eid="+r+"]"),o=i.find(".stats-likes");n.isEmbed||n.animateBigLike();var a="/elements/"+r+"/like",l={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("POST",a,l,{},function(r){r?s.notify.error(t("Error liking the element, please try again"),{element:"#container",duration:3e3}):(e.addClass("active"),n.incrementStat(o))})},elementUnlike:function(e){var n=this,r=e.parents(".s-element").attr("data-eid"),i=$(".s-element[data-eid="+r+"]"),o=i.find(".stats-likes"),a="/elements/"+r+"/unlike",l={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("POST",a,l,{},function(r){r?s.notify.error(t("Error un-liking the element, please try again"),{element:"#container",duration:3e3}):(e.removeClass("active"),n.decrementStat(o))})},elementCommentMore:function(e){e.preventDefault();var t=this,n=$(e.target),r=n.parents(".s-element"),i=r.find(".more"),o=r.find(".previous ul"),a=r.find(".element-comment-n"),l=r.attr("data-eid"),u=3;r.data("n")||r.data("n",1*a.text());var c=r.data("page")||2,d=r.data("n");i.addClass("loading");var h="/elements/"+l+"/comments",f={per_page:u,page:c,username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("GET",h,f,{},function(e,n){if(e)i.remove();else{var l=n.content.comments;l.forEach(function(e){o.append(s.templates.render("story/elements/_comment",{comment:e}))}),d-=u,r.data("page",++c),0>=d?i.remove():(r.data("n",d),a.text(d),i.removeClass("loading")),t.updateTimestamps(o)}})},elementCommentRemove:function(e){e.preventDefault();var n=this,r=$(e.currentTarget),i=r.parents(".s-element"),o=r.parents(".comment"),a=i.find(".stats-comments"),l=o.attr("data-id"),u=i.attr("data-eid");if(confirm("Are you sure?")){var c="/elements/"+u+"/comments/remove",d={username:s.auth.user.username,_token:s.auth.user._token,comment:l,sid:s.story.sid};s.api.request("POST",c,d,{},function(e){e?s.notify.error(t("Error removing a comment from the element, please try again"),{element:"#container",duration:3e3}):(o.remove(),n.decrementStat(a))})}},elementCommentSubmit:function(e){if(13==e.keyCode){e.preventDefault();var t=this,n=$(e.currentTarget),r=n.val();n.parents(".s-element"),$.fn.tipsy&&n.parents(".action-container").find(".element-comment-post, .story-comment-post").tipsy("hide"),r&&(s.auth.user?t.elementComment(n,r):s.auth.loginPopup(function(e,i){!e&&i&&(t.postMessage({method:"login",value:i}),t.elementComment(n,r))}))}},elementComment:function(e,t){var n=this,r=e.parents(".s-element"),i=r.find(".stats-comments"),o=r.find(".element-comment-facebook").hasClass("active"),a=r.find(".element-comment-twitter").hasClass("active"),l=r.attr("data-eid");e.prop("disabled",!0);var u="/elements/"+l+"/comments/add",c={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid,comment:_.trim(t),twitter:a,facebook:o};s.api.request("POST",u,c,{},function(t,o){if(t)e.val("").prop("disabled",!1);else{var a=o.content,l=$(s.templates.render("story/elements/_comment",{comment:a,prune:!1}));r.find(".previous ul").prepend(l),n.updateTimestamps(),e.val("").blur(),e.prop("disabled",!1),n.incrementStat(i);var u=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"element-comment",searchQuery:u,context:"embed-local",auth:!0,source:r.attr("data-source")})}})},incrementStat:function(e,t){var t=1*e.html()+(t||1);e.html(t)},decrementStat:function(e,t){var t=t||1;this.incrementStat(e,-t)},incrementStatModal:function(e){var t=parseInt(e.text())+1;e.find("span").text(t),e.show(),e.parents(".shared-element-actions").find("a.like").removeClass("no-like")},decrementStatModal:function(e){var t=parseInt(e.text())-1;e.find("span").text(t),0===t&&(e.hide(),e.parents(".shared-element-actions").find("a.like").addClass("no-like"))},elementCommentButtonClicked:function(e){e.preventDefault();var t=this,n=$(e.currentTarget),r=n.parents(".s-element"),i=r.find(".comments"),s=r.find(".buttons .comment");s.toggleClass("pressed"),i.slideToggle(200,function(){t.resize(),i.is(":visible")&&i.find(".element-comment-input").focus()})},elementShareButtonClicked:function(e){var t=$(e.target);t.parents(".s-element"),e.stopPropagation(),e.preventDefault();var t=$(e.target).hasClass("share")?$(e.target):$(e.target).parent();t.toggleClass("active");var n=t.parents(".s-element").find(".s-share-dropdown");n.toggle()},elementShareDropdownHide:function(e){return},subscribeButtonClicked:function(e){e.preventDefault();var t=this;analytics.track("engagement",{event:"story-subscribe",context:"embed-local",story:s.story.permalink,author:s.user.username,authenticated:!!s.auth.user}),s.auth.user?t.subscribe():s.auth.loginPopup(function(e,n){!e&&n&&(t.postMessage({method:"login",value:n}),t.subscribe())})},subscribe:function(){var e=this;s.auth.follow(s.user.username,function(t){t||(e.el.subscribeButton.hide(),e.el.subscribeLabel.hide(),e.el.subscribedLabel.removeClass("hidden"))})},likeButtonLiked:function(e){if(this.likeButton.enable(),this.embedLikeButton.enable(),this.el.embedLikeButton.addClass("active"),this.el.likeButton.addClass("active"),e!==!0){var t=this.el.likeButton.find(".like-count"),n=parseInt(t.html())+1;t.html(n),t.removeClass("hidden"),t=this.el.embedLikeButton.find(".like-count"),t.html(n),t.removeClass("hidden"),s.story.liked=!0;var r=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"story-like",searchQuery:r,context:"embed",auth:!0,source:"story"})}},likeButtonUnliked:function(e){if(this.likeButton.enable(),this.embedLikeButton.enable(),this.el.likeButton.removeClass("active"),this.el.embedLikeButton.removeClass("active"),e!==!0){var t=this.el.likeButton.find(".like-count"),n=parseInt(t.html())-1;t.html(n),0==n&&(this.el.likeButton.addClass("no-like"),t.addClass("hidden")),t=this.el.embedLikeButton.find(".like-count"),t.html(n),0==n&&(this.el.embedLikeButton.addClass("no-like"),t.addClass("hidden")),s.story.liked=!1}},likeError:function(e){var t,n=this;this.likeButton.enable(),this.embedLikeButton.enable();try{t=JSON.parse(e.responseText),t.error.message.match("duplicate_like")?(n.likeButtonLiked(!0),n.embedLikeButton(!0)):t.error.message.match("not_liked")&&(n.likeButtonUnliked(!0),n.embedLikeButton(!0))}catch(r){}},like:function(){var e=this;e.likeButton&&e.likeButton.disable(),e.embedLikeButton&&e.embedLikeButton.disable(),e.isEmbed||e.animateBigLike();var t="/stories/"+s.user.username+"/"+s.story.slug+"/like",n={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",t,n,{},function(t,n){t?e.likeError(t):e.likeButtonLiked(n)})},unlike:function(){var e=this;e.likeButton&&e.likeButton.disable(),e.embedLikeButton&&e.embedLikeButton.disable();var t="/stories/"+s.user.username+"/"+s.story.slug+"/unlike",n={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",t,n,{},function(t,n){t?e.likeError(t):e.likeButtonUnliked(n)})},deactivateLike:function(){var e=this;s.auth.user?(e.unlike(),e.shareDropdown&&e.shareDropdown.deactivate()):s.auth.loginPopup(function(t,n){!t&&n&&(e.postMessage({method:"login",value:n}),e.unlike)})},activateLike:function(e){var t=this,n=$(e.target);n.parents(".s-element");var r=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"story-like",searchQuery:r,auth:!!s.auth.user,source:"story"}),s.auth.user?(t.like(),t.shareDropdown&&t.shareDropdown.activate()):s.auth.loginPopup(function(n,r){!n&&r&&(t.postMessage({method:"login",value:r}),t.like(e))})},animateBigLike:function(){var e=460,t=412,n=this;n.el.bigLike.show().animate({opacity:.8,width:e,height:t,marginLeft:e/-2,marginTop:t/-2},250,function(){setTimeout(function(){n.el.bigLike.animate({opacity:0,width:2*e,height:2*t,marginLeft:-e,marginTop:-t},250,function(){n.el.bigLike.hide().css({opacity:.8,width:e/2,height:t/2,marginLeft:e/-4,marginTop:t/-4})})},500)})},elementClick:function(e){var t=$(e.currentTarget),n=$("body").attr("data-query")||"no-query";analytics.track("browse",{event:"element-view",searchQuery:n,context:"embed-local",href:t.attr("href")})},embedCodeCopied:function(){var e=this;e.el.embedCopy.text("✓ copied").fadeOut("slow",function(){e.el.embedCopy.text("copy").fadeIn("fast")})},embedCodeClick:function(e){e.preventDefault(),$(this).select()},changeEmbedCode:function(){var e=this,t=[];this.el.embedOptions.length>0&&("slideshow"==this.el.embedTemplate.val()?(t.push("template=slideshow"),this.el.embedShowOptions.fadeOut("fast")):(this.el.embedShowOptions.fadeIn("fast"),this.el.embedHeader.attr("checked")||t.push("header=false"),this.el.embedBorder.attr("checked")||t.push("border=false"))),this.el.embedSEO.attr("checked")&&!this.seo?$.get(s.base_url+"/"+this.path+"/text",function(n){e.seo=n,e.setEmbedCode(t)}):this.setEmbedCode(t)},setEmbedCode:function(e){e=e.join("&");var t={base:s.base_url,username:s.user.username,slug:s.story.slug,title:s.story.title,options:e?"?"+e:"",seo:this.el.embedSEO.attr("checked")?this.seo||"":""},n=s.utils.template(this.embedCodeTemplate,t);this.el.embedSEO.attr("checked")&&this.seo&&(n+=this.seo),n+="</noscript></div>",this.el.embedCode.val(n)},sendEmail:function(){var e=this,n={to:this.el.emailTo.val(),from:this.el.emailFrom.val()};if(!n.from)return this.el.emailFrom.addClass("error").focus(),void 0;if(!n.to)return this.el.emailTo.addClass("error").focus(),void 0;this.el.emailSend.attr("disabled",!0).find("span").text(t("Sending"));var r="/stories/"+s.user.username+"/"+s.story.slug+"/email",i=n;s.api.request("POST",r,i,{},function(n){n?(e.el.emailSend.removeAttr("disabled").find("span").text(t("Send")),e.el.emailResultError.show(),setTimeout(function(){e.el.emailResultError.fadeOut(500)},3e3)):(e.el.emailSend.removeAttr("disabled").find("span").text(t("Send")),e.el.emailTo.val(""),e.el.emailResultSuccess.show(),setTimeout(function(){e.el.emailResultSuccess.fadeOut(500)},3e3))})},onMessage:function(e){var t=e.originalEvent.data;switch(t){case"loadMore":this.has_feature("infinite_scroll",this.loadMore);break;case"enableAutoReload":this.autoReload=!0;break;case"disableAutoReload":this.autoReload=!1;break;default:/^hashchange:/.test(t)&&this.linkClick("#"+t.slice(11))}},loadMore:function(e){var n=this,r=s.store.get("user");"function"!=typeof e&&(e=function(){}),n.el.loadMore.attr("disabled",!0),s.api.request("GET","/stories/"+n.path,{per_page:n.per_page,page:n.page++,published:"true"!==n.el.loadMore.attr("data-preview"),username:r&&r.username?r.username:void 0,_token:r&&r._token?r._token:void 0},{retryLimit:3},function(r,i){function o(){--d<=0&&e(null,h)}if(r)s.notify.error(t("Error loading more, please try again"),{element:"#container",duration:3e3}),n.el.loadMore.attr("disabled",!1),e&&e(r);else{s.story=i.content;var a=i.content.elements,l=n.page>20?!1:!0,u=!!$("#embed-footer").length,c={story:s.story,sid:s.story.sid,elements:a,embedTweets:l,isEmbed:u};a=$(s.templates.render("story/_elementsList",c)),n.el.elementsList.append(a);var d=1,h=!1;"undefined"!=typeof twttr&&twttr&&twttr.widgets&&(setTimeout(twttr.widgets.load,1),d++,twttr.events.bind("loaded",o)),"undefined"!=typeof FB&&FB&&FB.init&&setTimeout(function(){d++,FB.XFBML.parse(document.body,o)},1),"object"==typeof sidenotes&&sidenotes.updateAnchors(".s-element:not(.s-element-text) > div, .s-text > p, .s-text:not(:has(p, h2))"),a.length<n.per_page?(n.el.loadMore.remove(),n.postMessage({method:"noMoreElements"}),h=!1,o()):(n.el.loadMore.removeAttr("disabled"),h=!0,o()),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow())}),n.render(),s.page&&s.page.reinitialize()}})},reload:function(e){var t=this,n=s.store.get("user"),r="/stories/"+t.path,i={per_page:t.per_page,username:n&&n.username?n.username:void 0,_token:n&&n._token?n._token:void 0,timestamp:s.story.date.published};s.api.request("GET",r,i,{},function(n,r){if(n)e(n);else{if(r.content.version===s.story.version)return e();s.story=r.content;var i=r.content.elements;s.story.date.published=r.content.date.published,i=s.templates.render("story/_elementsList",{sid:s.story.sid,elements:i,embedTweets:!0}),t.page=2,t.el.elementsList.html(i),$(".s-published-date").attr("data-timestamp",s.story.date.published),"undefined"!=typeof twttr&&twttr&&setTimeout(twttr.widgets.load,1),"undefined"!=typeof FB&&FB&&FB.init&&setTimeout(function(){FB.init({status:!0,cookie:!0,xfbml:!0})
},1),i.length<t.per_page&&(t.el.loadMore.remove(),t.postMessage({method:"noMoreElements"})),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow())}),t.render(),e()}})},ensureResize:function(e,t){var n=this,e=e||20,t=t||200,r=setInterval(function(){n.resize(),e--||clearInterval(r)},t)},resize:function(e){if(!e){if(!$("body")||!$("body").height())return;e=$("body").height()}300>=e||(this.height=e,this.postMessage({method:"resize",value:this.height}))},postMessage:function(e){return s.story?(e.sourceName=s.story.author.username+"-"+s.story.slug,window.parent.postMessage(JSON.stringify(e),"*"),void 0):(s.raven&&s.raven.started&&s.raven.Raven.captureMessage("embed.local.js:1448. Why no story? : "+JSON.stringify(s)),void 0)},bottomLinkClicked:function(){return!0},bottomLikeClicked:function(){var e=this,t=$("body").attr("data-query")||"no-query";return analytics.track("engagement",{event:"story-like",searchQuery:t,context:"embed-local"}),s.story.liked?alert("Thank you but you already liked this story!"):(this.like(),this.el.bottomLiked.fadeIn(250,function(){setTimeout(function(){e.el.bottomLiked.fadeOut(250)},3e3)})),!1},shareButtonClicked:function(e){e.preventDefault();var t=$(e.target),n=t.parents(".s-element"),r=t.attr("rel"),i=t.data("media"),o=t.parents(".s-actions-share").data("url"),a='From "'+s.story.title+'" story by '+s.story.author.name+" on Storify — "+s.story.permalink,l=t.data("video"),u=s.story.title,c=n.attr("data-type"),d=function(e){return e&&0!=e.length?"“"+e.replace(/<a[^>]+>([^<]+)<\/a>/g,function(e,t){return e.match(/twitter\.com/)?t:""}).replace(/RT @([^ ]){1,15}:?/g,"").replace(/( ){2,}/g," ").replace(/^ | $/g,"")+"”":""};switch(c){case"quote":u=d(n.find(".s-quote-text").html());break;case"image":u=d(n.find(".s-image-caption").html())}switch(r){case"storify":this.elementStorypadAdd(c,n.data("permalink"));break;case"email":analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:"email",type:n.attr("data-type")}),window.location.href="mailto:?subject="+s.story.title+"&body="+o;break;case"pinterest":analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:"pinterest",type:n.attr("data-type")}),this.pin(i,o,a,l);break;case"facebook":analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:"facebook",type:n.attr("data-type")}),this.share(r,o,s.story.title);break;default:analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:r,type:n.attr("data-type")}),this.share(r,o,s.story.title)}},share:function(e,t,n){var r;switch(e){case"facebook":r="http://www.facebook.com/sharer.php?u="+encodeURIComponent(t);break;case"twitter":r="http://twitter.com/intent/tweet?text="+encodeURIComponent(n)+"&url="+encodeURIComponent(t);var i=$('meta[property="twitter:creator"]').attr("content")||"Storify";n.length<105&&(r+="&via="+i);break;case"googleplus":r="http://plus.google.com/share?url="+encodeURIComponent(t);break;case"linkedin":r="http://www.linkedin.com/shareArticle?url="+encodeURIComponent(t)}window.open(r,"sharer","toolbar=0,status=0,resizable=1,width=626,height=436")},shareFacebookImg:function(e){var t=e.find(".s-share-facebook");t.addClass("s-share-facebook-loading");var n="/elements/"+e.attr("data-eid")+"/share",r={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("POST",n,r,{},function(e){e||(t.removeClass("s-share-facebook-loading"),t.addClass("s-share-facebook-done"),setTimeout(function(){t.fadeOut(500,function(){t.removeClass("s-share-facebook-done"),t.show()})},2e3))})},pin:function(e,t,n,r){window.open("http://pinterest.com/pin/create/bookmarklet/?media="+encodeURIComponent(e)+"&url="+encodeURIComponent(t)+"&description="+encodeURIComponent(n)+"&is_video="+encodeURIComponent(r),"sharer","toolbar=0,status=0,resizable=1,width=632,height=270")},showFocus:function(e){$input=$(e.target),$input.parents(".action").addClass("focus")},hideFocus:function(e){$input=$(e.target),$input.parents(".action").removeClass("focus"),$.fn.tipsy&&$input.parents(".action-container").find(".element-comment-post, .story-comment-post").tipsy("hide")},updateTimestamps:function(e){var e=e?e.find(".moment.fromNow"):$(".moment.fromNow");e.each(function(){var e=$(this);e.html(moment(e.attr("data-date")).fromNow())})},embedLikeButtonClicked:function(e){e.preventDefault(),$target=$(e.currentTarget),$target.hasClass("active")?this.embedUnlike($target):this.embedLike($target)},embedLike:function(e){var t=this,n="/stories/"+s.user.username+"/"+s.story.slug+"/like",r={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",n,r,{},function(n){n||(e.addClass("active"),t.incrementStat($target.find(".like-count")))})},embedUnlike:function(e){var t=this,n=e.parents(".s-element").attr("data-eid"),r=$(".s-element[data-eid="+n+"]");r.find(".stats-likes");var i="/stories/"+s.user.username+"/"+s.story.slug+"/unlike",o={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",i,o,{},function(n){n||(e.removeClass("active"),t.decrementStat($target.find(".like-count")))})},getRelatedStories:function(){return},renderRelatedStories:function(e){e&&0!==e.length&&(this.isEmbed?this.renderRelatedStoriesEmbed(e):this.renderRelatedStoriesOnStorify(e))},renderRelatedStoriesEmbed:function(e){switch(e.length){case 1:$("#story #related-stories h3").text(t("related_story"));break;case 3:var n=Math.floor(Math.random()*e.length);e=e.slice(),e.splice(n,1)}var r=(Math.min(window.innerWidth||630,630)-125)/6-18,i=self.isEmbed?"embed":"storypage";for(var o in e){var a=e[o];a.author?a.author.name=a.author.name||a.author.username:a.author={name:""};var l=$('<a href="'+a.permalink+"?utm_source=story&utm_media="+i+'&utm_content=related" target="_blank" class="related-story-title">'+s.utils.smart_truncate(a.title,Math.max(r,45))+"</a> "),u=$('<a href="https://storify.com/'+a.author.username+'" target="_blank" class="related-story-author">('+a.author.name+")</a>");a.description=a.description||"";var c=a.thumbnail&&!a.thumbnail.match(/public\/img\/default\-thumb/)?'<img src="'+s.utils.proxy_image(a.thumbnail,50)+'" class="related" />':"",d="<b>"+a.title+"</b><p>"+c+a.description+"</p>";analytics.trackLink(l,"click_related_story_from_embed"),$.fn.tipsy&&l.tipsy({opacity:.95,fade:!0,html:!0,trigger:"hover",gravity:"sw",fallback:d,offset:2});var h=$("<li>").append(l).append(u);$("#story #related-stories ul.stories").append(h)}$("#story #related-stories").show()},renderRelatedStoriesOnStorify:function(e){$("#related-stories").show();for(var t=$("#related-stories ul"),n=t.find("li.template"),r=0;r<e.length;r++){var i=e[r];i.thumbnail.match(/\/public\/img\/default-thumb\.gif$/)&&(i.thumbnail="/public/img/related-placeholder@2x.png");var s=n.clone();s.find(".thumbnail").css("background-image",'url("'+i.thumbnail+'")'),s.find("a.permalink").attr("href",i.permalink),s.find(".title").text(i.title),s.removeClass("hidden"),t.append(s)}},linkClick:function(e){function t(e){return e.origin||e.protocol+"//"+e.hostname+(e.port?":"+e.port:"")}function n(e){return e.pathname.replace(/^\//,"")}function r(e,t){var n=$(s);n.length>0?l?(i.postMessage({method:"scroll",value:n.offset().top}),i.postMessage({method:"setHash",value:s})):$("html, body").animate({scrollTop:n.offset().top},"fast",function(){window.location.hash=s}):t&&(l?i.postMessage({method:"scroll",value:i.el.loadMore.offset().top}):$("html, body").animate({scrollTop:i.el.loadMore.offset().top},"fast"),i.loadMore(r))}var i=this;if("string"==typeof e)var s=e;else if(e&&e.preventDefault){var o=e.currentTarget,a=window.location;if(t(o)===t(a)&&n(o)===n(a)){e.preventDefault();var s=o.hash}}if(s){var l=!0;try{l=window.self!==window.top}catch(e){}r(null,!0)}}}),$(function(){new s.Embed}),s.Search=s.Class.extend({initialize:function(e){var t=this;this.el={form:$(e),input:$(e).find("input"),button:$(e).find("button"),logo:$("h1#logo a"),buttonGroup:$("ul.button-group"),nav:$("#head .nav"),close:$("#landing-message .close")},_.bindAll(this,"resizeInput","showFocus","hideFocus","expand","collapse","submit","track","close"),this.el.input.bind("focus",this.showFocus),this.el.input.bind("blur",this.hideFocus),this.el.form.bind("submit",this.submit),this.el.close.bind("click",this.close),this.el.button.bind("click",function(){return $(window).width()<660&&!t.el.input.is(":visible")?(t.expand(),!1):void 0}),this.el.input.bind("blur",function(){$(window).width()<660&&t.collapse()}),this.resizeInput(),$(window).bind("resize",this.resizeInput),this.track(),s.store&&s.store.get("user")||s.cookie.get("welcome")&&1==s.cookie.get("welcome")||$("#landing-message").show()},resizeInput:function(){this.el.input.is(":focus")&&this.el.input.blur(),$(window).width()<660?this.el.input.hide():this.el.input.show()},showFocus:function(){this.el.form.addClass("focus")},hideFocus:function(){this.el.form.removeClass("focus")},expand:function(){this.el.input.show().focus(),this.el.buttonGroup.hide(),this.el.nav.hide()},collapse:function(){this.el.input.addClass("default").hide(),this.el.buttonGroup.show(),this.el.nav.show()},submit:function(){return""==this.el.input.val()?!1:void 0},track:function(){""!=this.el.input.val()&&(analytics.track("search",{context:"results",query:this.el.input.val()}),$("body").attr("data-query",this.el.input.val()))},close:function(){$("#landing-message").hide(),s.cookie.get("welcome")+1,s.cookie.set("welcome",!0)}}),s.Website=s.Class.extend({initialize:function(){this.el={subscribersCount:$(".user-stats .subscribers"),subscriptionsCount:$(".user-stats .subscriptions"),subscribersModal:$("#subscribers"),subscriptionsModal:$("#subscriptions"),loginButton:$("#login-button"),signupButton:$("#signup-button"),contactLink:$("#contact-link"),contactModal:$("#contact")},_.bindAll(this,"addNextParam","showContactModal","hideContactModal");var e=s.auth&&s.auth.user?s.auth.user.paid_plan:"prospect",t="free"!==e&&"prospect"!==e?"pro":"";$("body").addClass(e).addClass(t),$("#head").length>0&&(s.nav=new s.Nav),s.search=new s.Search("#search"),setInterval(function(){_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");s.utils&&t.text(s.utils.date(n).fromNow())})},6e4),this.el.contactLink.click(this.showContactModal),this.el.contactModal.click(this.hideContactModal),this.addNextParam()},addNextParam:function(){var e=encodeURIComponent(window.location.pathname);this.el.loginButton.attr("href","/login?next="+e),this.el.signupButton.attr("href","/signup?next="+e)},showContactModal:function(e){e.preventDefault(),this.el.contactModal.show()},hideContactModal:function(e){"contact"===$(e.target).attr("id")&&this.el.contactModal.hide()}}),s.pages.Story=s.Class.extend({initialize:function(){var e=this;_.bindAll(this,"reinitialize","toggleEmbedsDropdown","closeEmbedsDropdown","setCover","openShareElementModal","shareElement","addToStorypad","animateBigLike","like","unlike","openShareStoryModal","openElementModal"),this.el={window:$(window),document:$(document),viewsCount:$("#cover .stats .views"),embedsDropdown:$("#cover .stats .embeds"),shareElementButton:$("#story .storifycon-share"),shareElementViaService:$("#share-element-modal .services div"),shareElementViaPinterest:$("#share-element-modal .storifycon-source-pinterest"),setCoverButton:$("#story .storifycon-photograph"),bigLike:$("#big-like"),likeButton:$("#story-container .story-buttons .storifycon-like"),shareStoryButton:$("#story-container .story-buttons .storifycon-share"),elementModal:$("#element-modal")},s.toolbar=new s.Toolbar,this.shareElementModal=new s.Modal("#share-element-modal"),this.elementModal=new s.Modal("#element-modal",{hide:function(){history.pushState&&history.pushState({eid:null},document.title,"/"+s.story.author.username+"/"+s.story.slug)}}),this.el.viewsCount.click(this.toggleEmbedsDropdown),$("html").click(this.closeEmbedsDropdown),s.story.liked&&this.el.likeButton.addClass("btn-red").removeClass("btn-blue"),this.el.likeButton.click(function(){s.story.liked?e.unlike():e.like()}),this.el.shareStoryButton.click(this.openShareStoryModal),this.el.shareElementButton.click(this.openShareElementModal),this.el.shareElementViaService.click(this.shareElement),this.el.setCoverButton.click(this.setCover),window.location.href.match(/\/elements\//)&&this.openElementModal(window.location.href.match(/[a-f0-9]+$/));var t=0;this.el.window.scroll(function(){var n=e.el.document.height(),r=$(".s-load-more");r.length&&"disabled"!==r.attr("disabled")&&e.el.window.scrollTop()+e.el.window.height()>=(t+n)/2&&(t=n,r.attr("disabled",!0),r.click())})},reinitialize:function(){this.el.shareElementButton=$("#story .storifycon-share"),this.el.setCoverButton=$("#story .storifycon-photograph"),this.el.shareElementButton.click(this.openShareElementModal),this.el.setCoverButton.click(this.setCover)},toggleEmbedsDropdown:function(){this.el.embedsDropdown.toggleClass("visible")},closeEmbedsDropdown:function(e){$(e.target)[0]!==this.el.viewsCount[0]&&this.el.embedsDropdown.removeClass("visible")},setCover:function(e){var n="/stories/"+s.story.author.username+"/"+s.story.slug+"/cover",r=$(e.currentTarget).data("image");s.api.request("POST",n,{username:s.auth.user.username,_token:s.auth.user._token,cover:r},{},function(e){e?s.notify.error(t("There was an error setting the cover image."),{element:"#container",slideSpeed:200,duration:3e3}):$("#cover").css("background-image",'url("'+r+'")')})},openShareElementModal:function(e){this.el.shareElementViaPinterest.addClass("hidden");var t=this.shareButton=$(e.currentTarget);(t.data("image")||t.data("video"))&&this.el.shareElementViaPinterest.removeClass("hidden"),this.shareElementModal.show()},shareElement:function(e){var t=$(e.currentTarget),n=this.shareButton.parents(".s-element"),r=t.data("service"),i=this.shareButton.data("url"),o='From "'+s.story.title+'" story by '+s.story.author.name+" on Storify — "+s.story.permalink;if("storify"===r)this.addToStorypad(n.attr("data-type"),n.data("permalink"));else{switch(analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:r,type:n.attr("data-type")}),r){case"email":window.location.href="mailto:?subject="+s.story.title+"&body="+i;break;case"pinterest":if(this.shareButton.data("image"))var a="http://pinterest.com/pin/create/bookmarklet/?media="+encodeURIComponent(this.shareButton.data("image"))+"&url="+encodeURIComponent(i)+"&description="+encodeURIComponent(o)+"&is_video="+encodeURIComponent(!1);else var a="http://pinterest.com/pin/create/bookmarklet/?media="+encodeURIComponent(this.shareButton.data("video"))+"&url="+encodeURIComponent(i)+"&description="+encodeURIComponent(o)+"&is_video="+encodeURIComponent(!0);break;case"facebook":var a="http://www.facebook.com/sharer.php?u="+encodeURIComponent(i);break;case"twitter":var a="http://twitter.com/intent/tweet?text="+encodeURIComponent(s.story.title)+"&url="+encodeURIComponent(i),l=$('meta[property="twitter:creator"]').attr("content")||"Storify";s.story.title.length<105&&(a+="&via="+l);break;case"googleplus":var a="http://plus.google.com/share?url="+encodeURIComponent(i);break;case"linkedin":var a="http://www.linkedin.com/shareArticle?url="+encodeURIComponent(i)}a&&window.open(a,"sharer","toolbar=0,status=0,resizable=1,width=626,height=436")}},addToStorypad:function(e,t){var n={type:e,permalink:t},r={utm_content:e,utm_medium:"storyPage"};sfy&&sfy.showModal&&(n.via=s.story.permalink,s.auth.user?sfy.showModal(n,r):s.auth.loginPopup(function(e,t){!e&&t&&sfy.showModal(n,r)}))},animateBigLike:function(){var e=this,t=460,n=412;e.el.bigLike.show().animate({opacity:.8,width:t,height:n,marginLeft:t/-2,marginTop:n/-2},250,function(){setTimeout(function(){e.el.bigLike.animate({opacity:0,width:2*t,height:2*n,marginLeft:-t,marginTop:-n},250,function(){e.el.bigLike.hide().css({opacity:.8,width:t/2,height:n/2,marginLeft:t/-4,marginTop:n/-4})})},500)})},like:function(){var e=this;if(s.auth.user){var n="/stories/"+s.user.username+"/"+s.story.slug+"/like",r={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",n,r,{},function(n){if(n)s.notify.error(t("There was an error liking this story."),{element:"#container",slideSpeed:200,duration:3e3});else{var r=parseInt(e.el.likeButton.text());r?e.el.likeButton.text(r+1):e.el.likeButton.text("1"),e.el.likeButton.addClass("btn-red").removeClass("btn-blue"),s.story.liked=!0,e.animateBigLike()}})}else s.auth.loginPopup(function(e,t){!e&&t&&location.reload()})},unlike:function(){var e=this,n="/stories/"+s.user.username+"/"+s.story.slug+"/unlike",r={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",n,r,{},function(n){if(n)s.notify.error(t("There was an error unliking this story."),{element:"#container",slideSpeed:200,duration:3e3});else{var r=parseInt(e.el.likeButton.text());1===r?e.el.likeButton.text("Like"):e.el.likeButton.text(r-1),e.el.likeButton.addClass("btn-blue").removeClass("btn-red"),s.story.liked=!1}})},openShareStoryModal:function(){s.toolbar.shareStoryModal.show()},openElementModal:function(e){var t=this,n=s.auth.user?{username:s.auth.user.username,_token:s.auth.user._token}:{};n.sid=s.story.sid;var r="/elements/"+e;s.api.request("GET",r,n,{},function(e,n){e||n.error||!n.content||(t.el.elementModal.empty(),t.el.elementModal.append(s.templates.render("element/_modal",{element:n.content,context:s.base_url,modal:!0})),t.elementModal.show())})}}),s.Toolbar=s.Class.extend({initialize:function(){var e=this;_.bindAll(this,"closeMenus","toggleOptions","toggleTemplates","changeTemplate","selectTemplate","saveTemplate","openNotifyModal","notifyUpdateChars","toggleNotifyPerson","notify","openEmbedModal","showEmbedTemplates","hideEmbedTemplates","changeEmbedTemplate","changeHeaderOption","gatherOptions","updateEmbedCode","selectAll","openShareStoryModal","shareStory","makePrivate","makePublic","openChangeUrlModal","saveUrl","updateSlug","openExportModal","exportStory","openUnpublishModal","unpublishStory","openDeleteModal","deleteStory","inputTitle"),this.el={optionsButton:$("#toolbar .storifycon-more"),optionsDropdown:$("#toolbar .options"),templatesButton:$("#toolbar .storifycon-templates"),templatesDropdown:$("#toolbar .templates"),template:$("#toolbar .template"),saveButton:$("#toolbar .templates .save"),cancelButton:$("#toolbar .templates .cancel"),toolbarNotifyButton:$("#toolbar .storifycon-notify"),notifyChars:$("#notify-modal .chars span"),notifyTweet:$("#notify-modal textarea"),notifyPerson:$("#notify-modal .person"),modalNotifyButton:$("#notify-modal .storifycon-source-twitter"),embedButton:$("#toolbar .storifycon-embed"),showEmbedTemplatesButton:$("#embed-modal .show-templates"),hideEmbedTemplatesButton:$("#embed-modal .hide-templates"),embedTemplatesDropdown:$("#embed-modal .templates"),embedTemplate:$("#embed-modal .template"),headerOption:$("#embed-modal .header-options>div"),borderOption:$('#embed-modal input[value="border"]'),htmlOption:$('#embed-modal input[value="html"]'),embedCode:$("#embed-modal textarea"),shareStoryButton:$("#toolbar .storifycon-share"),shareStoryViaService:$("#share-story-modal .services>div"),makePrivateButton:$("#toolbar .storifycon-private"),makePublicButton:$("#toolbar .storifycon-public"),changeUrlButton:$("#toolbar .storifycon-source-link"),urlSlug:$("#change-url-modal input"),saveUrlButton:$("#change-url-modal .save"),exportButton:$("#toolbar .storifycon-export"),exportFormat:$("#export-modal .formats > div:not(.disabled)"),unpublishButton:$("#toolbar .unpublish"),confirmUnpublishButton:$("#unpublish-modal .unpublish"),deleteButton:$("#toolbar .storifycon-delete"),confirmDeleteButton:$("#delete-modal .delete"),storyTitle:$("#delete-modal .story-title"),storyTitleInput:$("#delete-modal .story-title-input")},this.maxTweetSize=123,this.template=$("#toolbar .template.select").data("template"),this.embedModal=new s.Modal("#embed-modal"),this.notifyModal=new s.Modal("#notify-modal"),this.shareStoryModal=new s.Modal("#share-story-modal"),this.changeUrlModal=new s.Modal("#change-url-modal"),this.exportModal=new s.Modal("#export-modal"),this.unpublishModal=new s.Modal("#unpublish-modal"),this.deleteModal=new s.Modal("#delete-modal"),$("#export-modal .storifycon-export-pdf").tipsy(),$("html").click(this.closeMenus),this.el.optionsButton.click(this.toggleOptions),this.el.templatesButton.click(this.toggleTemplates),this.el.template.click(this.selectTemplate),this.el.saveButton.click(this.saveTemplate),this.el.cancelButton.click(this.toggleTemplates),$(function(){$.fn.tipsy&&e.el.template.tipsy({delayIn:10,live:!0,gravity:"s",opacity:1,className:"template-tooltip"})}),this.el.toolbarNotifyButton.click(this.openNotifyModal),this.el.notifyTweet.bind("keydown keyup change",this.notifyUpdateChars),this.el.notifyPerson.click(this.toggleNotifyPerson),this.el.modalNotifyButton.click(this.notify),this.el.embedButton.click(this.openEmbedModal),this.el.showEmbedTemplatesButton.click(this.showEmbedTemplates),this.el.hideEmbedTemplatesButton.click(this.hideEmbedTemplates),this.el.embedTemplate.click(function(t){e.changeEmbedTemplate(t),e.gatherOptions()}),this.el.headerOption.click(function(t){e.changeHeaderOption(t),e.gatherOptions()}),this.el.borderOption.change(this.gatherOptions),this.el.htmlOption.change(this.gatherOptions),this.el.embedCode.click(this.selectAll),this.el.shareStoryButton.click(this.openShareStoryModal),this.el.shareStoryViaService.click(this.shareStory),this.el.makePrivateButton.click(this.makePrivate),this.el.makePublicButton.click(this.makePublic),this.el.changeUrlButton.click(this.openChangeUrlModal),this.el.saveUrlButton.click(this.saveUrl),this.el.exportButton.click(this.openExportModal),this.el.exportFormat.click(this.exportStory),this.el.unpublishButton.click(this.openUnpublishModal),this.el.confirmUnpublishButton.click(this.unpublishStory),this.el.deleteButton.click(this.openDeleteModal),this.el.storyTitleInput.bind("input",this.inputTitle),this.deleteStoryButton=new s.Button(this.el.confirmDeleteButton,{click:this.deleteStory}),this.deleteStoryButton.disable(),"#publicize"===window.location.hash&&this.el.notifyPerson.length&&this.openNotifyModal()},closeMenus:function(e){var t=$(e.target),n=this.el.optionsDropdown.hasClass("visible"),r=this.el.templatesDropdown.hasClass("visible"),i=t[0]===this.el.optionsButton[0],s=t[0]===this.el.templatesButton[0],o=t[0]===this.el.templatesDropdown[0]||-1!==t.parents().index(this.el.templatesDropdown);n&&!i&&this.toggleOptions(),r&&!s&&!o&&this.toggleTemplates()},toggleOptions:function(){this.el.optionsDropdown.toggleClass("visible")},toggleTemplates:function(){this.el.templatesDropdown.hasClass("visible")?this.changeTemplate(this.template):(this.el.template.removeClass("select"),$('#toolbar .template[data-template="'+this.template+'"]').addClass("select")),this.el.templatesButton.toggleClass("select"),this.el.templatesDropdown.toggleClass("visible")},changeTemplate:function(e){var t=$("#story"),n=$("#story .default"),r=$("#story-frame");if("story"===e)r.remove(),n.removeClass("hidden");else if(n.addClass("hidden"),r.length){r[0].height="750px";var i=r[0].src.split("=");i[i.length-1]=e,r[0].src=i.join("=")}else{var i=s.base_url+"/"+s.story.author.username+"/"+s.story.slug+"/embed?header=none&template="+e;t.append('<iframe id="story-frame" src="'+i+'" width="100%" height="750" frameborder="no" allowtransparency="true"></iframe>')}},selectTemplate:function(e){var t=$(e.currentTarget);this.el.template.removeClass("select"),t.addClass("select"),this.changeTemplate(t.data("template"))},saveTemplate:function(){var e=this,t=$("#toolbar .template.select").data("template"),n="/stories/"+s.story.author.username+"/"+s.story.slug+"/template";s.api.request("POST",n,{username:s.auth.user.username,_token:s.auth.user._token,template:t},{},function(){e.template=t,e.toggleTemplates()})},openNotifyModal:function(){this.notifyModal.show(),this.notifyUpdateChars()},notifyUpdateChars:function(){var e=this.maxTweetSize-twttr.txt.getTweetLength(this.el.notifyTweet.val());this.el.notifyChars.text(e),this.notifyCharsLeft=e,0>e?this.el.notifyChars.addClass("over-limit"):this.el.notifyChars.removeClass("over-limit")},toggleNotifyPerson:function(e){$(e.currentTarget).toggleClass("storifycon-published")},notify:function(){var e=this;if(this.notifyCharsLeft<0)return alert("Your notification message is too long. Please make it shorter."),void 0;var n={message:this.el.notifyTweet.val(),users:[]};if($("#notify-modal .person.storifycon-published").each(function(e,t){n.users.push($(t).data("json"))}),0===n.users.length)return alert("You must select at least one person to notify."),void 0;var r="/stories/"+s.user.username+"/"+s.story.slug+"/notify";s.api.request("POST",r,{notification:JSON.stringify(n),published:!0,username:s.auth.user.username,_token:s.auth.user._token},{},function(n){n?(s.notify.error(t("Error notifying sources."),{element:"#container",slideSpeed:200,duration:3e3}),e.notifyModal.hide()):($("#notify-modal .person.storifycon-published").remove(),e.notifyModal.hide())})},openEmbedModal:function(){this.el.embedTemplate.removeClass("select"),$('#embed-modal .template[data-template="'+s.toolbar.template+'"]').addClass("select"),this.hideEmbedTemplates(),this.embedModal.show(),this.gatherOptions()},showEmbedTemplates:function(){this.el.showEmbedTemplatesButton.addClass("hidden"),this.el.hideEmbedTemplatesButton.removeClass("hidden"),this.el.embedTemplatesDropdown.removeClass("hidden")},hideEmbedTemplates:function(){this.el.hideEmbedTemplatesButton.addClass("hidden"),this.el.embedTemplatesDropdown.addClass("hidden"),this.el.showEmbedTemplatesButton.removeClass("hidden")},changeEmbedTemplate:function(e){this.el.embedTemplate.removeClass("select"),$(e.currentTarget).addClass("select")},changeHeaderOption:function(e){this.el.headerOption.removeClass("select"),$(e.currentTarget).addClass("select")},gatherOptions:function(){var e=this,t=[],n=$("#embed-modal .header-options .select").data("header");"none"===n?t.push("header=none"):"mini"===n&&t.push("header=false"),this.el.borderOption.is(":checked")||t.push("border=false");var r=$("#embed-modal .template.select").data("template");("grid"===r||"slideshow"===r)&&t.push("template="+r),this.el.htmlOption.is(":checked")&&!this.seo&&$.get(s.base_url+"/"+s.user.username+"/"+s.story.slug+"/text",function(n){e.seo=n,e.updateEmbedCode(t)}),this.updateEmbedCode(t)},updateEmbedCode:function(e){var t='<div class="storify"><iframe src="{{base}}/{{username}}/{{slug}}/embed{{options}}" width="100%" height="750" frameborder="no" allowtransparency="true"></iframe><script src="{{base}}/{{username}}/{{slug}}.js{{options}}"></script><noscript>[<a href="{{base}}/{{username}}/{{slug}}" target="_blank">View the story "{{title}}" on Storify</a>]',n={base:s.base_url,username:s.user.username,slug:s.story.slug,title:s.story.title,options:e&&e.length>0?"?"+e.join("&"):""},r=s.utils.template(t,n);this.el.htmlOption.is(":checked")&&this.seo&&(r+=this.seo),r+="</noscript></div>",this.el.embedCode.val(r)},selectAll:function(e){$(e.currentTarget).select()},openShareStoryModal:function(){this.shareStoryModal.show()},shareStory:function(e){analytics.track("engagement-share",{event:"story-shared"});var t=window.location.protocol+s.base_url+"/"+s.story.author.username+"/"+s.story.slug,n=$(e.currentTarget).data("service");switch(n){case"facebook":var r="http://www.facebook.com/sharer.php?u="+encodeURIComponent(t);break;case"twitter":var r="http://twitter.com/intent/tweet?text="+encodeURIComponent(s.story.title)+"&url="+encodeURIComponent(t),i=$('meta[property="twitter:creator"]').attr("content")||"Storify";s.story.title.length<105&&(r+="&via="+i);break;case"google-plus":r="http://plus.google.com/share?url="+encodeURIComponent(t)}window.open(r,"sharer","toolbar=0,status=0,resizable=1,width=626,height=436")},makePrivate:function(){var e=this;if(s.auth.user.features_enabled.private_stories||s.story.author.features_enabled.private_stories){var n="/stories/"+s.story.author.username+"/"+s.story.slug+"/getObfuscatedSlug",r={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",n,r,{},function(n,r){if(n)s.notify.error(t("There was an error getting the obfuscated URL"),{element:"#container",slideSpeed:200,duration:3e3});else if(200===r.code){var i="/stories/"+s.story.author.username+"/"+s.story.slug+"/obfuscate",o=r.content;e.updateSlug(i,o)}else s.notify.error(t("There was an error getting the obfuscated URL"),{element:"#container",slideSpeed:200,duration:3e3})})}else s.notify.error(t("That option is only available to business users."),{element:"#container",slideSpeed:200,duration:3e3})},makePublic:function(){var e=this,n="/stories/"+s.story.author.username+"/"+s.story.slug+"/getDeobfuscatedSlug",r={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",n,r,{},function(n,r){if(n)s.notify.error(t("There was an error getting the deobfuscated URL"),{element:"#container",slideSpeed:200,duration:3e3});else if(200===r.code){var i="/stories/"+s.story.author.username+"/"+s.story.slug+"/deobfuscate",o=r.content;e.updateSlug(i,o)}else s.notify.error(t("There was an error getting the deobfuscated URL"),{element:"#container",slideSpeed:200,duration:3e3})})},openChangeUrlModal:function(){this.changeUrlModal.show(),this.el.urlSlug.val(s.story.slug)},saveUrl:function(){var e=this;if(s.story.not_indexed)s.notify.error(t("Private links cannot be modified."),{element:"#container",slideSpeed:200,duration:3e3});else{var n=this.el.urlSlug.val();if(n===s.story.slug)return $("#change-url-modal .cancel").click();var r={username:s.auth.user.username,_token:s.auth.user._token,slug:n},i="/stories/"+s.story.author.username+"/"+s.story.slug+"/checkForUniqueness";s.api.request("POST",i,r,{},function(r,i){if(r)s.notify.error(t("There was an error updating the URL"),{element:"#container",slideSpeed:200,duration:3e3});else{if(i.content.isUnique){var o="/stories/"+s.story.author.username+"/"+s.story.slug+"/editslug";return e.updateSlug(o,n)}s.notify.error(t("URL already exists"),{element:"#container",slideSpeed:200,duration:3e3})}})}},updateSlug:function(e,n){var r={username:s.auth.user.username,_token:s.auth.user._token,sessionID:s.store.get("sessionID"),slug:n};s.api.request("POST",e,r,{},function(e,n){e?s.notify.error(t("There was an error updating the URL"),{element:"#container",slideSpeed:200,duration:3e3}):window.location=n.content.permalink+(n.content.date.published||"published"===n.content.status?"":"/preview")})},openExportModal:function(){this.exportModal.show()},exportStory:function(e){var t=$(e.currentTarget).data("format");"json"===t?window.open("//api.storify.com/v1/stories/"+s.story.author.username+"/"+s.story.slug,"_blank"):window.open(s.base_url+"/"+s.story.author.username+"/"+s.story.slug+"."+t,"_blank")},openUnpublishModal:function(){this.unpublishModal.show()},unpublishStory:function(){var e=this,n="/stories/"+s.story.author.username+"/"+s.story.slug+"/unpublish";s.api.request("POST",n,{username:s.auth.user.username,_token:s.auth.user._token},{},function(n){n?(s.notify.error(t("Error unpublishing story."),{element:"#content",slideSpeed:200,duration:3e3}),e.unpublishModal.hide()):/preview/.test(window.location.pathname)?window.location.reload():window.location.pathname+="/preview"})},openDeleteModal:function(){this.el.storyTitle.text(s.story.title),this.deleteModal.show(),this.el.storyTitleInput.val("").focus()},inputTitle:function(e){var t=$(e.target).val().trim().toLowerCase(),n=this.el.storyTitle.text().trim().toLowerCase();t===n?this.deleteStoryButton.enable():this.deleteStoryButton.disable()},deleteStory:function(){var e=this,n="/stories/"+s.story.author.username+"/"+s.story.slug+"/delete";s.api.request("POST",n,{username:s.auth.user.username,_token:s.auth.user._token},{},function(n){n?(s.notify.error(t("Error deleting story."),{element:"#container",slideSpeed:200,duration:3e3}),e.deleteModal.hide()):(e.deleteModal.hide(),window.location="/"+s.user.username)
})}});

//@ sourceMappingURL=3.2.81-production-01175131-10118a240da3fa13871c5bf5044ee1d3.js.map